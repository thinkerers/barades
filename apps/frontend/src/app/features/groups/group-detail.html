<div class="group-detail-container">
  @if (isOffline()) {
  <div class="offline-banner" role="status">
    <mat-icon class="offline-banner__icon" aria-hidden="true">warning</mat-icon>
    <div class="offline-banner__content">
      <strong>Connexion perdue.</strong>
      <span>Vérifiez votre réseau puis réessayez.</span>
    </div>
    <button
      type="button"
      class="offline-banner__retry"
      (click)="retryLoading()"
    >
      Réessayer
    </button>
  </div>
  }

  <!-- Loading State -->
  @let currentGroup = group(); @if (loading()) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Chargement des détails du groupe...</p>
  </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
  <lib-error-message
    [message]="error() ?? defaultErrorMessage"
    [actionLabel]="isOffline() ? undefined : 'Réessayer'"
    (action)="retryLoading()"
  ></lib-error-message>
  } @if (error() && !loading()) {
  <div class="error-secondary-actions">
    <button
      type="button"
      class="error-secondary-actions__button"
      (click)="goBack()"
    >
      Retour aux groupes
    </button>
  </div>
  }

  <!-- Group Details -->
  @if (!loading() && currentGroup) {
  <div class="group-detail">
    <!-- Header -->
    <header class="group-detail__header">
      <button (click)="goBack()" class="back-button">
        <mat-icon class="back-button__icon" aria-hidden="true"
          >arrow_back</mat-icon
        >
        Retour
      </button>
      <div class="group-detail__title-section">
        <h1 class="group-detail__title">{{ currentGroup.name }}</h1>
        <span
          class="playstyle-badge"
          [ngClass]="'playstyle--' + getPlaystyleColor(currentGroup.playstyle)"
        >
          {{ getPlaystyleLabel(currentGroup.playstyle) }}
        </span>
      </div>
      <div class="group-detail__meta">
        <span
          class="status-badge"
          [ngClass]="{
          'status--recruiting': currentGroup.isRecruiting && !isFull(),
          'status--full': isFull(),
          'status--private': !currentGroup.isRecruiting
        }"
        >
          @if (currentGroup.isRecruiting && !isFull()) {
          <span>Recrutement ouvert</span>
          } @if (isFull()) {
          <span>Groupe complet</span>
          } @if (!currentGroup.isRecruiting) {
          <span>Groupe privé</span>
          }
        </span>
        @if (currentGroup.creator) {
        <span class="meta-item">
          <mat-icon aria-hidden="true">person</mat-icon>
          Créé par <strong>{{ currentGroup.creator.username }}</strong>
        </span>
        }
      </div>
    </header>
    <!-- Description -->
    <section class="group-detail__section">
      <h2>Description</h2>
      <p class="description">{{ currentGroup.description }}</p>
    </section>
    <!-- Poll Section -->
    <section class="group-detail__section">
      <h2>Sondage de dates</h2>
      <app-poll-widget
        [poll]="activePoll()"
        [groupId]="currentGroup.id"
        [currentUserId]="currentUserId"
        [isMember]="isMember()"
        (pollCreated)="onPollCreated($event)"
        (voted)="onVoted()"
      ></app-poll-widget>
    </section>
    <!-- Members Section -->
    <section class="group-detail__section">
      <div class="section-header">
        <h2>
          Membres
          <span class="count-badge">
            {{ memberCount() }} @if (currentGroup.maxMembers) {
            <span>/ {{ currentGroup.maxMembers }}</span>
            }
          </span>
        </h2>
        <div class="section-actions">
          @if (canJoin()) {
          <button
            (click)="joinGroup()"
            class="btn btn--primary btn--small"
            [disabled]="joinInProgress()"
          >
            <mat-icon aria-hidden="true">person_add</mat-icon>
            {{ joinInProgress() ? 'Rejoindre...' : 'Rejoindre' }}
          </button>
          } @if (isMember()) {
          <button
            (click)="leaveGroup()"
            class="btn btn--danger btn--small"
            [disabled]="leaveInProgress()"
          >
            <mat-icon aria-hidden="true">logout</mat-icon>
            {{ leaveInProgress() ? 'Quitter...' : 'Quitter le groupe' }}
          </button>
          } @if (joinError()) {
          <p class="join-error">{{ joinError() }}</p>
          } @if (leaveError()) {
          <p class="join-error">{{ leaveError() }}</p>
          }
        </div>
      </div>
      @if (currentGroup.members && currentGroup.members.length > 0) {
      <div class="members-grid">
        @for (member of currentGroup.members; track member.userId) {
        <div class="member-card">
          @if (member.user.avatar) {
          <img
            [src]="member.user.avatar"
            [alt]="member.user.username"
            class="member-card__avatar"
          />
          } @if (!member.user.avatar) {
          <div class="member-card__avatar member-card__avatar--placeholder">
            <mat-icon aria-hidden="true">person</mat-icon>
          </div>
          }
          <div class="member-card__info">
            <span class="member-card__name">{{ member.user.username }}</span>
            <span class="member-card__joined">
              Membre depuis {{ formatDate(member.joinedAt) }}
            </span>
          </div>
        </div>
        }
      </div>
      } @if (!currentGroup.members || currentGroup.members.length === 0) {
      <div class="empty-state">
        <mat-icon aria-hidden="true">group_off</mat-icon>
        <p>Aucun membre pour le moment</p>
      </div>
      }
    </section>
    <!-- Sessions Section -->
    <section class="group-detail__section">
      <div class="section-header">
        <h2>
          Sessions à venir @if (currentGroup.sessions) {
          <span class="count-badge"> {{ currentGroup.sessions.length }} </span>
          }
        </h2>
      </div>
      @if (currentGroup.sessions && currentGroup.sessions.length > 0) {
      <div class="sessions-list">
        @for (session of currentGroup.sessions; track session.id) {
        <a [routerLink]="['/sessions', session.id]" class="session-card">
          <div class="session-card__header">
            <h3 class="session-card__title">{{ session.title }}</h3>
            @if (session._count) {
            <span class="session-card__participants">
              <mat-icon aria-hidden="true">groups</mat-icon>
              {{ session._count.reservations }}
            </span>
            }
          </div>
          <div class="session-card__details">
            <span class="session-card__date">
              <mat-icon aria-hidden="true">schedule</mat-icon>
              {{ formatDateTime(session.scheduledFor) }}
            </span>
            <span class="session-card__location">
              <mat-icon aria-hidden="true">place</mat-icon>
              {{ session.location.name }}
            </span>
          </div>
        </a>
        }
      </div>
      } @if (!currentGroup.sessions || currentGroup.sessions.length === 0) {
      <div class="empty-state">
        <mat-icon aria-hidden="true">event_busy</mat-icon>
        <p>Aucune session planifiée</p>
      </div>
      }
    </section>
  </div>
  }
</div>
