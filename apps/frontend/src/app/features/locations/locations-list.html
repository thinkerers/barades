<div class="locations-container">
  <lib-async-state
    [status]="locationsState"
    [loadingMessage]="loadingMessage"
    [errorMessage]="error ?? defaultErrorMessage"
    (retry)="retry()"
  ></lib-async-state>

  <div class="map-stage" [class.hidden]="locationsState !== 'ready'">
    <div
      id="map"
      class="map-stage__map"
      aria-label="Carte des lieux de jeu"
    ></div>
    <div class="map-stage__overlay map-stage__overlay--header">
      <section
        class="locations-filters-card"
        role="region"
        aria-label="Filtres de recherche des lieux"
      >
        <header class="locations-filters-card__header">
          <div class="locations-filters-card__title">
            <mat-icon aria-hidden="true">filter_alt</mat-icon>
            <div class="locations-filters-card__title-text">
              <h1>Lieux de jeu</h1>
              <p>Trouvez l'endroit idéal pour vos sessions</p>
            </div>
            @if (getActiveFiltersCount() > 0) {
            <span
              class="locations-filters-card__badge"
              aria-label="Nombre de filtres actifs"
            >
              {{ getActiveFiltersCount() }}
            </span>
            }
          </div>
          <button
            type="button"
            class="locations-filters-card__reset"
            (click)="resetFilters()"
            [disabled]="getActiveFiltersCount() === 0"
          >
            <mat-icon aria-hidden="true">refresh</mat-icon>
            Réinitialiser
          </button>
        </header>

        <div class="locations-filters-card__grid">
          <div
            class="locations-filters-card__field locations-filters-card__field--search"
          >
            <label class="field-label" for="search">Recherche</label>
            <lib-search-input
              icon="search"
              inputId="search"
              placeholder="Nom, adresse, ville..."
              [value]="searchTerm"
              (valueChange)="onSearchTermChange($event)"
            ></lib-search-input>
          </div>

          <mat-form-field
            appearance="outline"
            class="locations-filters-card__field locations-filters-card__field--type"
          >
            <mat-label>Type de lieu</mat-label>
            <mat-select
              [(ngModel)]="selectedType"
              (selectionChange)="applyFilters()"
            >
              @for (option of locationTypeOptions; track option.value) {
              <mat-option [value]="option.value">
                {{ option.label }}
              </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <div class="locations-filters-card__amenities">
          <span class="field-label">Équipements</span>
          <div class="amenities-checkboxes">
            @for (amenity of amenityFilters; track amenity.key) {
            <button
              type="button"
              class="amenity-toggle"
              [class.amenity-toggle--active]="filters[amenity.key]"
              (click)="toggleAmenity(amenity.key)"
            >
              <mat-icon aria-hidden="true">{{ amenity.icon }}</mat-icon>
              <span>{{ amenity.label }}</span>
            </button>
            }
          </div>
        </div>
      </section>
    </div>

    <div class="map-stage__overlay map-stage__overlay--list">
      <div
        class="locations-list"
        role="region"
        aria-label="Liste des lieux"
        [class.locations-list--collapsed]="isDetailsCollapsed"
      >
        <button
          type="button"
          class="locations-list__status-pill"
          (click)="toggleDetailsCollapse()"
          [attr.aria-expanded]="!isDetailsCollapsed"
          aria-controls="locations-details"
          [title]="
            isDetailsCollapsed
              ? 'Afficher la liste des lieux'
              : 'Masquer la liste des lieux'
          "
        >
          <mat-icon aria-hidden="true">
            {{ isDetailsCollapsed ? 'map' : 'assistant_navigation' }}
          </mat-icon>
          @if (isDetailsCollapsed) {
          <span class="locations-list__status-pill-text">Liste masquée</span>
          } @if (selectedLocation) {
          <span
            class="locations-list__status-pill-count"
            [class.locations-list__status-pill-count--with-separator]="isDetailsCollapsed"
          >
            Lieu sélectionné (1 / {{ filteredLocations.length }})
          </span>
          } @else {
          <span
            class="locations-list__status-pill-count"
            [class.locations-list__status-pill-count--with-separator]="isDetailsCollapsed"
          >
            Liste des lieux ({{ filteredLocations.length }} / {{
            locations.length }})
          </span>
          }
        </button>

        @if (refreshing) {
        <div class="locations-list__refresh" role="status" aria-live="polite">
          Mise à jour des lieux...
        </div>
        }

        <div id="locations-details">
          @if (!isDetailsCollapsed) {
          <h2 class="locations-details__heading">Détails du lieu</h2>

          <div class="locations-details__content">
            @if (selectedLocation; as location) {
            <article
              [id]="'location-' + location.id"
              class="locations-details__selected-card"
            >
              <header class="locations-details__selected-header">
                <div class="locations-details__selected-title">
                  <mat-icon aria-hidden="true">push_pin</mat-icon>
                  <div class="locations-details__selected-meta">
                    <h3>{{ location.name }}</h3>
                    <span class="locations-details__type"
                      >{{ getLocationTypeLabel(location.type) }}</span
                    >
                  </div>
                </div>
                <button
                  type="button"
                  class="locations-details__close"
                  (click)="selectedLocationId = null"
                  aria-label="Effacer le lieu sélectionné"
                >
                  <mat-icon aria-hidden="true">close</mat-icon>
                </button>
              </header>

              <section class="locations-details__selected-body">
                <ul class="locations-details__info-list">
                  @if (location.address || location.city) {
                  <li class="locations-details__info-row">
                    <mat-icon aria-hidden="true">location_on</mat-icon>
                    <span>
                      {{ location.address ? (location.address + ', ' +
                      location.city) : location.city }}
                    </span>
                  </li>
                  }
                  <li class="locations-details__info-row">
                    <mat-icon aria-hidden="true">star</mat-icon>
                    <span>{{ location.rating.toFixed(1) }}/5</span>
                  </li>
                  @if (location.capacity) {
                  <li class="locations-details__info-row">
                    <mat-icon aria-hidden="true">groups</mat-icon>
                    <span>Capacité: {{ location.capacity }} personnes</span>
                  </li>
                  }
                </ul>

                @if (location.amenities.length > 0) {
                <div class="locations-details__amenities">
                  @for (amenity of location.amenities; track amenity) {
                  <span class="locations-details__amenity">
                    <mat-icon aria-hidden="true">
                      {{ getAmenityIconName(amenity) }}
                    </mat-icon>
                    <span>{{ amenity }}</span>
                  </span>
                  }
                </div>
                }

                <div class="locations-details__actions">
                  @if (location.website) {
                  <a
                    [href]="location.website"
                    target="_blank"
                    rel="noopener"
                    class="locations-details__action-link"
                  >
                    <mat-icon aria-hidden="true">language</mat-icon>
                    Site web
                  </a>
                  }
                </div>
              </section>
            </article>
            } @else {
            <div class="locations-details__placeholder">
              <mat-icon aria-hidden="true">touch_app</mat-icon>
              <div>
                <h3>Sélectionnez un lieu sur la carte</h3>
                <p>
                  Cliquez sur un indicateur ou sur une entrée de la carte pour
                  afficher ses informations détaillées ici.
                </p>
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
