<div class="locations-container">
  <lib-async-state
    [status]="locationsState"
    [loadingMessage]="loadingMessage"
    [errorMessage]="error ?? defaultErrorMessage"
    (retry)="retry()"
  ></lib-async-state>

  <div class="map-stage" [class.hidden]="locationsState !== 'ready'">
    <div
      id="map"
      class="map-stage__map"
      aria-label="Carte des lieux de jeu"
    ></div>
    <div class="map-stage__overlay map-stage__overlay--header">
      <section
        class="locations-filters-card"
        role="region"
        aria-label="Filtres de recherche des lieux"
      >
        <header class="locations-filters-card__header">
          <div class="locations-filters-card__title">
            <mat-icon aria-hidden="true">filter_alt</mat-icon>
            <div class="locations-filters-card__title-text">
              <h1>Lieux de jeu</h1>
              <p>Trouvez l'endroit idéal pour vos sessions</p>
            </div>
            @if (getActiveFiltersCount() > 0) {
            <span
              class="locations-filters-card__badge"
              aria-label="Nombre de filtres actifs"
            >
              {{ getActiveFiltersCount() }}
            </span>
            }
          </div>
          <button
            type="button"
            class="locations-filters-card__reset"
            (click)="resetFilters()"
            [disabled]="getActiveFiltersCount() === 0"
          >
            <mat-icon aria-hidden="true">refresh</mat-icon>
            Réinitialiser
          </button>
        </header>

        <div class="locations-filters-card__grid">
          <div
            class="locations-filters-card__field locations-filters-card__field--search"
          >
            <label class="field-label" for="search">Recherche</label>
            <div class="field-control field-control--icon">
              <mat-icon aria-hidden="true">search</mat-icon>
              <input
                type="text"
                id="search"
                [(ngModel)]="searchTerm"
                (input)="applyFilters()"
                placeholder="Nom, adresse, ville..."
                autocomplete="off"
              />
            </div>
          </div>

          <div
            class="locations-filters-card__field locations-filters-card__field--type"
          >
            <label class="field-label" for="type-filter">Type de lieu</label>
            <div
              class="field-control field-control--icon field-control--select"
            >
              <mat-icon aria-hidden="true">layers</mat-icon>
              <select
                id="type-filter"
                [(ngModel)]="selectedType"
                (change)="applyFilters()"
              >
                <option value="">Tous les types</option>
                <option value="GAME_STORE">Boutique de jeux</option>
                <option value="CAFE">Café</option>
                <option value="BAR">Bar</option>
                <option value="COMMUNITY_CENTER">Centre communautaire</option>
                <option value="OTHER">Autre</option>
              </select>
            </div>
          </div>
        </div>

        <div class="locations-filters-card__amenities">
          <span class="field-label">Équipements</span>
          <div class="amenities-checkboxes">
            <button
              type="button"
              class="amenity-toggle"
              [class.amenity-toggle--active]="filters.wifi"
              (click)="toggleAmenity('wifi')"
            >
              <mat-icon aria-hidden="true">wifi</mat-icon>
              <span>WiFi</span>
            </button>
            <button
              type="button"
              class="amenity-toggle"
              [class.amenity-toggle--active]="filters.tables"
              (click)="toggleAmenity('tables')"
            >
              <mat-icon aria-hidden="true">table_restaurant</mat-icon>
              <span>Tables de jeu</span>
            </button>
            <button
              type="button"
              class="amenity-toggle"
              [class.amenity-toggle--active]="filters.food"
              (click)="toggleAmenity('food')"
            >
              <mat-icon aria-hidden="true">restaurant</mat-icon>
              <span>Nourriture</span>
            </button>
            <button
              type="button"
              class="amenity-toggle"
              [class.amenity-toggle--active]="filters.drinks"
              (click)="toggleAmenity('drinks')"
            >
              <mat-icon aria-hidden="true">local_cafe</mat-icon>
              <span>Boissons</span>
            </button>
            <button
              type="button"
              class="amenity-toggle"
              [class.amenity-toggle--active]="filters.parking"
              (click)="toggleAmenity('parking')"
            >
              <mat-icon aria-hidden="true">local_parking</mat-icon>
              <span>Parking</span>
            </button>
          </div>
        </div>
      </section>
    </div>

    <div class="map-stage__overlay map-stage__overlay--list">
      <div
        class="locations-list"
        role="region"
        aria-label="Liste des lieux"
        [class.locations-list--collapsed]="isDetailsCollapsed"
      >
        <button
          type="button"
          class="locations-list__status-pill"
          (click)="toggleDetailsCollapse()"
          [attr.aria-expanded]="!isDetailsCollapsed"
          aria-controls="locations-details"
          [title]="
            isDetailsCollapsed
              ? 'Afficher la liste des lieux'
              : 'Masquer la liste des lieux'
          "
        >
          <mat-icon aria-hidden="true">
            {{ isDetailsCollapsed ? 'map' : 'assistant_navigation' }}
          </mat-icon>
          @if (isDetailsCollapsed) {
          <span class="locations-list__status-pill-text">Liste masquée</span>
          } @if (selectedLocation) {
          <span
            class="locations-list__status-pill-count"
            [class.locations-list__status-pill-count--with-separator]="isDetailsCollapsed"
          >
            Lieu sélectionné (1 / {{ filteredLocations.length }})
          </span>
          } @else {
          <span
            class="locations-list__status-pill-count"
            [class.locations-list__status-pill-count--with-separator]="isDetailsCollapsed"
          >
            Liste des lieux ({{ filteredLocations.length }} / {{
            locations.length }})
          </span>
          }
        </button>

        <div id="locations-details">
          @if (!isDetailsCollapsed) {
          <h2>Liste des lieux</h2>

          <div class="location-cards">
            @if (selectedLocation; as location) {
            <div
              [id]="'location-' + location.id"
              class="location-card selected"
              (click)="onLocationClick(location.id)"
              role="button"
              tabindex="0"
              (keydown.enter)="onLocationClick(location.id)"
              (keydown.space)="onLocationClick(location.id)"
            >
              <div class="location-header">
                <h3>{{ location.name }}</h3>
                <span class="location-type"
                  >{{ getLocationTypeLabel(location.type) }}</span
                >
              </div>
              <div class="location-info">
                @if (location.address) {
                <div class="info-row">
                  <mat-icon aria-label="Adresse">place</mat-icon>
                  <span>{{ location.address }}, {{ location.city }}</span>
                </div>
                } @if (location.city && !location.address) {
                <div class="info-row">
                  <mat-icon aria-label="Ville">place</mat-icon>
                  <span>{{ location.city }}</span>
                </div>
                }
                <div class="info-row">
                  <mat-icon aria-label="Note">star</mat-icon>
                  <span>{{ location.rating.toFixed(1) }}/5</span>
                </div>
                @if (location.capacity) {
                <div class="info-row">
                  <mat-icon aria-label="Capacité">groups</mat-icon>
                  <span>Capacité: {{ location.capacity }} personnes</span>
                </div>
                }
              </div>
              @if (location.amenities.length > 0) {
              <div class="amenities">
                @for (amenity of location.amenities; track amenity) {
                <span class="amenity-tag">{{ amenity }}</span>
                }
              </div>
              }
              <div class="location-actions">
                @if (location.website) {
                <a
                  [href]="location.website"
                  target="_blank"
                  rel="noopener"
                  class="website-button"
                >
                  <mat-icon aria-label="Site web">public</mat-icon>
                  Site web
                </a>
                }
              </div>
            </div>
            } @else {
            <div class="locations-list__empty">
              <mat-icon aria-hidden="true">touch_app</mat-icon>
              <div>
                <h3>Sélectionnez un lieu sur la carte</h3>
                <p>
                  Cliquez sur un indicateur ou sur une entrée de la carte pour
                  afficher ses informations détaillées ici.
                </p>
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
