<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#111827"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/111827/4f46e5?text=BD">
    <link rel="manifest" href=""> <!-- Href will be set by JS -->

    <title>Bar à Dés - Votre plateforme de Jeu de Rôle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha26-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Flatpickr Date Picker Library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
    
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .glass-card {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #374151;
            color: #d1d5db;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        /* Styles for autocomplete suggestions */
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestion-item:hover {
            background-color: #4f46e5;
        }
        /* Custom form control styles */
        .form-select, .form-input, .form-textarea {
             background-color: #374151;
             border: 1px solid #4b5563;
             color: #d1d5db;
             border-radius: 0.5rem;
             padding: 0.75rem 1rem;
             width: 100%;
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        .form-checkbox {
            accent-color: #4f46e5;
        }
        /* Leaflet popup customization */
        .leaflet-popup-content-wrapper {
            background-color: #1f2937;
            color: #d1d5db;
            border-radius: 0.5rem;
            border: 1px solid #374151;
        }
        .leaflet-popup-content {
            margin: 13px 20px;
        }
        .leaflet-popup-tip {
            background: #1f2937;
        }
        .leaflet-popup-close-button {
            color: #d1d5db !important;
        }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: #1f2937 !important;
            color: #d1d5db !important;
            border: 1px solid #374151 !important;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Scheduling Poll Styles */
        .poll-table {
            border-collapse: separate;
            border-spacing: 0 4px; /* Spacing between rows */
        }
        .poll-table th, .poll-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #374151;
        }
        .poll-table th {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af;
        }
        .poll-table td:first-child {
            text-align: left;
            font-weight: 500;
        }
        .poll-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .poll-cell:hover, .poll-cell.is-current-user:hover {
            background-color: #4b5563;
        }
        .poll-cell.available {
             background-color: rgba(16, 185, 129, 0.3); /* Green */
        }
        .poll-cell.available.is-current-user, .poll-cell.available:hover {
            background-color: #10b981;
        }
        .best-date {
            background-color: #4f46e5 !important;
            color: white;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        /* FAQ Details/Summary styles */
        details summary {
            cursor: pointer;
            padding: 1.25rem;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details summary::-webkit-details-marker {
            display: none;
        }
        details summary .lucide-chevron-down {
            transition: transform 0.3s;
        }
        details[open] summary .lucide-chevron-down {
            transform: rotate(180deg);
        }
        details > div {
            padding: 0 1.25rem 1.25rem 1.25rem;
            border-top: 1px solid #374151;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Header / Navigation -->
    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-700">
        <nav class="container mx-auto px-4 lg:px-6 py-3">
            <div class="flex justify-between items-center">
                <a href="#/" class="text-2xl font-bold text-white tracking-wider">
                    <span class="text-indigo-400">Bar</span> à Dés
                </a>
                <div class="hidden lg:flex items-center space-x-6">
                    <a href="#/sessions" class="text-gray-300 hover:text-indigo-400 transition">Trouver une Partie</a>
                    <a href="#/map" class="text-gray-300 hover:text-indigo-400 transition">Lieux de Jeu</a>
                    <a href="#/groups" class="text-gray-300 hover:text-indigo-400 transition">Groupes</a>
                    <a href="#/tools" class="text-gray-300 hover:text-indigo-400 transition">Outils</a>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="auth-links" class="">
                        <button id="login-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold hidden sm:inline-block">Connexion</button>
                        <button id="register-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold">Inscription</button>
                    </div>
                    <div id="user-menu" class="hidden items-center space-x-3">
                        <a href="#/profile" id="username-display" class="font-semibold text-white hover:text-indigo-400 transition"></a>
                        <a href="#/profile">
                            <img id="user-avatar" src="https://placehold.co/40x40/4338ca/ffffff?text=U" alt="User Avatar" class="rounded-full w-10 h-10 border-2 border-indigo-500 hover:border-indigo-400 transition">
                        </a>
                        <button id="logout-btn" class="btn-secondary p-2 rounded-full" title="Déconnexion"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                    <button id="mobile-menu-btn" class="lg:hidden text-white">
                        <i data-lucide="menu"></i>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 lg:px-6 py-12">
        <div id="main-content">
            <!-- Hero Section -->
            <section id="hero" class="text-center my-16">
                <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-4">
                    Votre Prochaine Aventure <span class="text-indigo-400">Commence Ici</span>
                </h1>
                <p class="text-lg md:text-xl text-gray-400 max-w-3xl mx-auto mb-8">
                    Trouvez des joueurs, des maîtres de jeu et des lieux pour vos parties de jeu de rôle, où que vous soyez.
                </p>
                <div class="glass-card max-w-4xl mx-auto p-6 shadow-2xl">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                        <div class="relative md:col-span-2">
                            <i data-lucide="swords" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-10"></i>
                            <input type="text" id="game-name-input" placeholder="Nom du jeu, univers (ex: D&D 5e, Cthulhu...)" class="w-full bg-gray-700 text-white border-gray-600 rounded-lg pl-10 pr-4 py-3 focus:ring-indigo-500 focus:border-indigo-500 relative" autocomplete="off">
                            <div id="game-suggestions" class="absolute top-full left-0 right-0 mt-2 bg-gray-800 border border-gray-600 rounded-lg z-20 hidden max-h-60 overflow-y-auto">
                                <!-- Suggestions will be populated here by JS -->
                            </div>
                        </div>
                        <div class="relative">
                             <i data-lucide="map-pin" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-10"></i>
                            <input type="text" id="city-name-input" placeholder="Ville ou en ligne" class="w-full bg-gray-700 text-white border-gray-600 rounded-lg pl-10 pr-4 py-3 focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                            <div id="city-suggestions" class="absolute top-full left-0 right-0 mt-2 bg-gray-800 border border-gray-600 rounded-lg z-20 hidden max-h-60 overflow-y-auto">
                                <!-- City suggestions will be populated here by JS -->
                            </div>
                        </div>
                        <button id="search-btn" class="btn-primary w-full py-3 rounded-lg font-bold flex items-center justify-center space-x-2">
                            <i data-lucide="search"></i>
                            <span>Rechercher</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Organisation de Sessions de JDR -->
            <section id="sessions-showcase" class="my-20">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">Parties à la Une</h2>
                    <a href="#/sessions" class="text-indigo-400 hover:underline">Voir toutes les parties</a>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Session Card 1 -->
                    <div class="glass-card p-6 flex flex-col hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="tag bg-red-800 text-red-100">Dungeons & Dragons 5e</span>
                                <h3 class="text-xl font-bold text-white mt-2">Le Tombeau de l'Annihilation</h3>
                            </div>
                            <div class="text-center">
                                <img src="https://placehold.co/48x48/4338ca/ffffff?text=MJ" alt="Avatar du MJ" class="rounded-full mx-auto">
                                <span class="text-xs text-gray-400 mt-1 block">Elara</span>
                            </div>
                        </div>
                        <div class="space-y-3 text-sm text-gray-300 mb-4 flex-grow">
                            <p class="flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-indigo-400"></i> Sam. 12 Octobre - 20h00</p>
                            <p class="flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2 text-indigo-400"></i> Bar "Le Dé Pipé", Paris</p>
                            <p class="flex items-center"><i data-lucide="user-check" class="w-4 h-4 mr-2 text-indigo-400"></i> Niveau : Intermédiaire</p>
                        </div>
                        <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-700">
                            <div class="flex items-center space-x-1">
                                <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                                <span class="font-semibold text-white">3 / 5 joueurs</span>
                            </div>
                            <button class="btn-secondary px-4 py-2 rounded-lg text-sm font-semibold">Voir les détails</button>
                        </div>
                    </div>
                    <!-- Session Card 2 -->
                    <div class="glass-card p-6 flex flex-col hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="tag bg-green-800 text-green-100">L'Appel de Cthulhu</span>
                                <h3 class="text-xl font-bold text-white mt-2">Les Masques de Nyarlathotep</h3>
                            </div>
                             <div class="text-center">
                                <img src="https://placehold.co/48x48/4338ca/ffffff?text=MJ" alt="Avatar du MJ" class="rounded-full mx-auto">
                                <span class="text-xs text-gray-400 mt-1 block">Victor</span>
                            </div>
                        </div>
                        <div class="space-y-3 text-sm text-gray-300 mb-4 flex-grow">
                            <p class="flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-indigo-400"></i> Ven. 18 Octobre - 21h00</p>
                            <p class="flex items-center"><i data-lucide="globe" class="w-4 h-4 mr-2 text-indigo-400"></i> En Ligne (Discord/Roll20)</p>
                            <p class="flex items-center"><i data-lucide="user-check" class="w-4 h-4 mr-2 text-indigo-400"></i> Ouvert à tous</p>
                        </div>
                        <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-700">
                            <div class="flex items-center space-x-1">
                                <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                                <span class="font-semibold text-white">2 / 4 joueurs</span>
                            </div>
                            <button class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold">Rejoindre</button>
                        </div>
                    </div>
                    <!-- Session Card 3 -->
                    <div class="glass-card p-6 flex flex-col hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                               <span class="tag bg-purple-800 text-purple-100">Cyberpunk RED</span>
                                <h3 class="text-xl font-bold text-white mt-2">Mission à Night City</h3>
                            </div>
                             <div class="text-center">
                                <img src="https://placehold.co/48x48/4338ca/ffffff?text=MJ" alt="Avatar du MJ" class="rounded-full mx-auto">
                                <span class="text-xs text-gray-400 mt-1 block">Jack</span>
                            </div>
                        </div>
                        <div class="space-y-3 text-sm text-gray-300 mb-4 flex-grow">
                            <p class="flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-indigo-400"></i> Dim. 20 Octobre - 14h00</p>
                            <p class="flex items-center"><i data-lucide="home" class="w-4 h-4 mr-2 text-indigo-400"></i> Lieu privé, Lyon</p>
                            <p class="flex items-center"><i data-lucide="user-check" class="w-4 h-4 mr-2 text-indigo-400"></i> Expérimentés</p>
                        </div>
                        <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-700">
                            <div class="flex items-center space-x-1">
                                <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                                <span class="font-semibold text-white">COMPLET</span>
                            </div>
                            <button class="btn-secondary px-4 py-2 rounded-lg text-sm font-semibold" disabled>Complet</button>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Planning CTA -->
            <section id="planning-cta" class="my-20">
                <div class="glass-card p-8 lg:p-12 bg-indigo-900/30 border-indigo-500">
                    <div class="flex flex-col lg:flex-row items-center justify-between gap-8">
                        <div class="text-center lg:text-left">
                            <h2 class="text-3xl font-bold text-white mb-2">Planifiez votre prochaine partie</h2>
                            <p class="text-indigo-200 text-lg max-w-2xl">
                                Utilisez notre outil simple et rapide pour trouver la date parfaite qui convient à tous vos joueurs.
                            </p>
                        </div>
                        <a href="#/plan" class="btn-primary px-8 py-4 rounded-lg font-bold text-lg whitespace-nowrap flex items-center space-x-2">
                            <i data-lucide="calendar-plus"></i>
                            <span>Créer un sondage</span>
                        </a>
                    </div>
                </div>
            </section>

            <!-- Map CTA -->
            <section id="map-cta" class="my-20 text-center">
                 <h2 class="text-3xl font-bold text-white mb-4">Trouvez le Lieu Idéal</h2>
                 <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-8">
                     Découvrez des bars à jeux, des associations et des boutiques près de chez vous sur notre carte interactive.
                 </p>
                <a href="#/map" class="btn-primary px-8 py-3 rounded-lg font-bold inline-flex items-center space-x-2 text-lg">
                    <i data-lucide="map"></i>
                    <span>Explorer la carte des lieux</span>
                </a>
            </section>

            <!-- Groupes CTA -->
            <section id="groups-cta" class="my-20">
                <div class="glass-card p-8 lg:p-12 bg-indigo-900/30 border-indigo-500">
                    <div class="flex flex-col lg:flex-row items-center justify-between gap-8">
                        <div class="text-center lg:text-left">
                            <h2 class="text-3xl font-bold text-white mb-2">Rejoignez une Communauté de Joueurs</h2>
                            <p class="text-indigo-200 text-lg max-w-2xl">
                                Que vous cherchiez un groupe stable pour une longue campagne ou des joueurs pour un one-shot, trouvez votre table idéale.
                            </p>
                        </div>
                        <a href="#/groups" class="btn-primary px-8 py-4 rounded-lg font-bold text-lg whitespace-nowrap">
                            Découvrir les groupes
                        </a>
                    </div>
                </div>
            </section>

            <!-- Outils CTA -->
            <section id="tools-cta" class="my-20 text-center">
                <h2 class="text-3xl font-bold text-white mb-4">Boîte à Outils du Rôliste</h2>
                <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-8">
                    Du lanceur de dés virtuel au générateur de fiches de personnages, trouvez tout ce dont vous avez besoin pour vos sessions.
                </p>
                <a href="#/tools" class="btn-primary px-8 py-3 rounded-lg font-bold inline-flex items-center space-x-2 text-lg">
                    <i data-lucide="wrench"></i>
                    <span>Découvrir les outils</span>
                </a>
            </section>
        </div>

        <!-- "Trouver une partie" View -->
        <section id="find-session-view" class="my-10 hidden">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                <h2 class="text-3xl font-bold text-white">Trouver une Partie</h2>
                <button class="btn-primary px-5 py-2 rounded-lg font-semibold flex items-center justify-center space-x-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Créer une session</span>
                </button>
            </div>
            <!-- Filters -->
            <div id="filters" class="glass-card p-6 mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                     <div>
                         <label for="filter-keyword" class="block text-sm font-medium text-gray-300 mb-2">Mot-clé / Titre</label>
                         <input type="text" id="filter-keyword" placeholder="Ex: 'Tombeau', 'Night City'..." class="form-input">
                     </div>
                     <div>
                        <label for="filter-game-system" class="block text-sm font-medium text-gray-300 mb-2">Système de jeu</label>
                        <select id="filter-game-system" class="form-select"></select>
                     </div>
                     <div>
                        <label for="filter-location" class="block text-sm font-medium text-gray-300 mb-2">Lieu</label>
                        <input type="text" id="filter-location" placeholder="Ex: 'Paris', 'En ligne'..." class="form-input">
                     </div>
                     <div class="flex flex-col justify-end">
                         <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="location-type" value="all" class="form-checkbox" checked>
                                <span>Tous</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="location-type" value="in-person" class="form-checkbox">
                                <span>En personne</span>
                            </label>
                             <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="location-type" value="online" class="form-checkbox">
                                <span>En ligne</span>
                            </label>
                         </div>
                         <label class="flex items-center space-x-2 mt-3 cursor-pointer">
                            <input type="checkbox" id="filter-availability" class="form-checkbox w-5 h-5">
                            <span>Places disponibles</span>
                        </label>
                     </div>
                 </div>
            </div>

            <!-- Results Grid -->
            <div id="sessions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Session results will be injected here -->
            </div>
            
            <!-- No Results Message -->
            <div id="no-sessions-found" class="hidden text-center glass-card p-12">
                <i data-lucide="search-x" class="w-24 h-24 text-indigo-400 mx-auto mb-6"></i>
                <h3 class="text-2xl font-bold text-white mb-2">Aucune partie ne correspond à vos filtres.</h3>
                <p class="text-gray-400 mb-6">Essayez d'élargir vos critères ou soyez le premier à lancer une nouvelle aventure !</p>
                <button class="btn-primary px-6 py-3 rounded-lg font-bold">
                    Créer une nouvelle session
                </button>
            </div>
        </section>

        <!-- "Lieux de Jeu" View -->
        <section id="find-location-view" class="my-10 hidden">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                <h2 class="text-3xl font-bold text-white">Découvrez des Lieux de Jeu</h2>
                <button class="btn-primary px-5 py-2 rounded-lg font-semibold flex items-center justify-center space-x-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Suggérer un lieu</span>
                </button>
            </div>
            <!-- Location Filters -->
            <div id="location-filters" class="glass-card p-6 mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                     <div>
                         <label for="filter-location-keyword" class="block text-sm font-medium text-gray-300 mb-2">Nom ou Ville</label>
                         <input type="text" id="filter-location-keyword" placeholder="Ex: 'Taverne', 'Bruxelles'..." class="form-input">
                     </div>
                     <div>
                        <label for="filter-location-type" class="block text-sm font-medium text-gray-300 mb-2">Type de lieu</label>
                        <select id="filter-location-type" class="form-select"></select>
                     </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Équipements</label>
                        <div id="filter-location-amenities" class="flex flex-wrap items-center gap-x-4 gap-y-2 pt-2">
                            <!-- Amenity checkboxes will be injected here -->
                        </div>
                     </div>
                 </div>
            </div>

            <!-- Content: Map and List -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 h-96 lg:h-[600px] rounded-2xl bg-gray-800 border-2 border-gray-700 relative overflow-hidden glass-card">
                    <div id="map" class="w-full h-full z-10"></div>
                </div>
                <div id="locations-list" class="lg:h-[600px] lg:overflow-y-auto space-y-4 pr-2 -mr-2">
                    <!-- Location cards will be injected here -->
                </div>
            </div>
            
            <!-- No Locations Found -->
            <div id="no-locations-found" class="hidden text-center glass-card p-12 mt-8">
                <i data-lucide="map-pin-off" class="w-24 h-24 text-indigo-400 mx-auto mb-6"></i>
                <h3 class="text-2xl font-bold text-white mb-2">Aucun lieu ne correspond à vos filtres.</h3>
                <p class="text-gray-400 mb-6">Changez vos critères ou aidez la communauté en suggérant un nouveau lieu !</p>
                <button class="btn-primary px-6 py-3 rounded-lg font-bold">
                    Suggérer un lieu
                </button>
            </div>
        </section>

        <!-- "Trouver un Groupe" View -->
        <section id="find-groups-view" class="my-10 hidden">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                <h2 class="text-3xl font-bold text-white">Trouver un Groupe</h2>
                <button class="btn-primary px-5 py-2 rounded-lg font-semibold flex items-center justify-center space-x-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Créer un groupe</span>
                </button>
            </div>
            <!-- Group Filters -->
            <div id="group-filters" class="glass-card p-6 mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                     <div>
                         <label for="filter-group-keyword" class="block text-sm font-medium text-gray-300 mb-2">Mot-clé</label>
                         <input type="text" id="filter-group-keyword" placeholder="Nom du groupe..." class="form-input">
                     </div>
                     <div>
                        <label for="filter-group-game" class="block text-sm font-medium text-gray-300 mb-2">Jeux principaux</label>
                        <select id="filter-group-game" class="form-select"></select>
                     </div>
                     <div>
                        <label for="filter-group-location" class="block text-sm font-medium text-gray-300 mb-2">Lieu</label>
                        <input type="text" id="filter-group-location" placeholder="Ville ou 'En ligne'" class="form-input">
                     </div>
                     <div class="flex flex-col justify-end">
                         <label class="block text-sm font-medium text-gray-300 mb-2">Style de jeu</label>
                         <div id="filter-group-playstyle" class="flex flex-wrap items-center gap-x-4 gap-y-2">
                             <!-- Playstyle radios will be injected here -->
                         </div>
                         <label class="flex items-center space-x-2 mt-3 cursor-pointer">
                            <input type="checkbox" id="filter-group-recruiting" class="form-checkbox w-5 h-5">
                            <span>Recrute</span>
                        </label>
                     </div>
                 </div>
            </div>

            <!-- Groups Grid -->
            <div id="groups-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Group cards will be injected here -->
            </div>
            
            <!-- No Groups Found -->
            <div id="no-groups-found" class="hidden text-center glass-card p-12 mt-8">
                <i data-lucide="users-2" class="w-24 h-24 text-indigo-400 mx-auto mb-6"></i>
                <h3 class="text-2xl font-bold text-white mb-2">Aucun groupe ne correspond à vos filtres.</h3>
                <p class="text-gray-400 mb-6">Soyez le premier à fonder une nouvelle guilde !</p>
                <button class="btn-primary px-6 py-3 rounded-lg font-bold">
                    Créer un nouveau groupe
                </button>
            </div>
        </section>
        
        <!-- "Outils" View -->
        <section id="tools-view" class="my-10 hidden">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-extrabold text-white">Boîte à Outils du Rôliste</h2>
                <p class="text-lg text-gray-400 max-w-2xl mx-auto mt-4">
                    Des outils pratiques pour enrichir vos sessions de jeu, du lancer de dés à la création de personnages.
                </p>
            </div>
        
            <!-- Tools Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Lanceur de Dés -->
                <div class="glass-card p-8 flex flex-col items-center justify-center text-center row-span-2">
                    <i data-lucide="dices" class="w-16 h-16 text-indigo-400 mx-auto mb-4"></i>
                    <h3 class="text-2xl font-bold text-white mb-2">Lanceur de Dés Virtuel</h3>
                    <p class="text-gray-400 mb-6 flex-grow">Lancez n'importe quelle combinaison de dés en un seul clic.</p>
                    <div class="w-full max-w-sm mx-auto">
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="dice-count" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label>
                                <input type="number" id="dice-count" value="1" min="1" max="100" class="form-input text-center">
                            </div>
                            <div class="col-span-2">
                                <label for="dice-type" class="block text-sm font-medium text-gray-300 mb-1">Type de Dé</label>
                                <select id="dice-type" class="form-select">
                                    <option value="4">d4</option>
                                    <option value="6">d6</option>
                                    <option value="8">d8</option>
                                    <option value="10">d10</option>
                                    <option value="12">d12</option>
                                    <option value="20" selected>d20</option>
                                    <option value="100">d100</option>
                                </select>
                            </div>
                        </div>
                        <button id="roll-dice-btn" class="btn-primary w-full py-3 rounded-lg font-bold flex items-center justify-center space-x-2">
                            <i data-lucide="play-circle"></i>
                            <span>Lancer</span>
                        </button>
                        <div id="dice-result-container" class="mt-4 bg-gray-900/50 p-4 rounded-lg min-h-[80px] flex items-center justify-center">
                             <p id="dice-result" class="text-4xl font-bold text-white tracking-wider"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Fiches de Personnage -->
                <div class="glass-card p-8 flex flex-col items-center justify-center text-center hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                     <i data-lucide="scroll-text" class="w-16 h-16 text-indigo-400 mx-auto mb-4"></i>
                     <h3 class="text-2xl font-bold text-white mb-2">Fiches de Personnages</h3>
                     <p class="text-gray-400 mb-6 flex-grow">Créez, sauvegardez et imprimez des fiches de personnage pour des centaines de jeux.</p>
                     <button class="btn-secondary px-6 py-3 rounded-lg font-semibold mt-auto">Accéder au générateur</button>
                </div>

                <!-- Ambiance Sonore -->
                 <div class="glass-card p-8 flex flex-col items-center justify-center text-center hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                     <i data-lucide="music" class="w-16 h-16 text-indigo-400 mx-auto mb-4"></i>
                     <h3 class="text-2xl font-bold text-white mb-2">Ambiance Sonore</h3>
                     <p class="text-gray-400 mb-6 flex-grow">Plongez vos joueurs dans l'ambiance avec des paysages sonores thématiques.</p>
                     <button class="btn-secondary px-6 py-3 rounded-lg font-semibold mt-auto">Ouvrir le lecteur</button>
                </div>
            </div>
            
            <!-- Affiliate Section -->
            <div id="affiliate-section" class="my-20">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-white mb-4">Équipez-vous pour l'Aventure</h2>
                    <p class="text-lg text-gray-400 max-w-3xl mx-auto mb-8">
                        Trouvez les meilleurs dés, manuels et accessoires grâce à nos recommandations et liens partenaires.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                     <div class="glass-card p-6 text-center hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                         <i data-lucide="book-open" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                         <h3 class="text-xl font-bold text-white mb-2">Manuels de Règles</h3>
                         <p class="text-gray-400 mb-4 text-sm">Les livres essentiels pour débuter ou maîtriser votre jeu préféré.</p>
                         <button class="btn-secondary px-5 py-2 rounded-lg font-semibold text-sm">Voir la sélection</button>
                    </div>
                     <div class="glass-card p-6 text-center hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                         <i data-lucide="dices" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                         <h3 class="text-xl font-bold text-white mb-2">Sets de Dés</h3>
                         <p class="text-gray-400 mb-4 text-sm">Des dés uniques pour refléter la personnalité de votre personnage.</p>
                         <button class="btn-secondary px-5 py-2 rounded-lg font-semibold text-sm">Trouver mes dés</button>
                    </div>
                     <div class="glass-card p-6 text-center hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                         <i data-lucide="box" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                         <h3 class="text-xl font-bold text-white mb-2">Accessoires</h3>
                         <p class="text-gray-400 mb-4 text-sm">Tours à dés, tapis de jeu, figurines... L'essentiel pour une immersion totale.</p>
                         <button class="btn-secondary px-5 py-2 rounded-lg font-semibold text-sm">Découvrir</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- "À Propos" View -->
        <section id="about-view" class="my-10 hidden">
            <div class="max-w-4xl mx-auto text-center">
                <h2 class="text-4xl font-extrabold text-white">À Propos de <span class="text-indigo-400">Bar à Dés</span></h2>
                <p class="text-lg text-gray-400 mt-4">
                    Notre mission est de rendre le jeu de rôle accessible à tous, en connectant les joueurs, les maîtres de jeu et les communautés, une partie à la fois.
                </p>
            </div>
        
            <div class="glass-card max-w-4xl mx-auto p-8 mt-12 text-left space-y-8">
                <div>
                    <h3 class="text-2xl font-bold text-white mb-4 flex items-center"><i data-lucide="rocket" class="w-6 h-6 mr-3 text-indigo-400"></i>Notre Mission</h3>
                    <p class="text-gray-300">
                        Chez Bar à Dés, nous croyons que le jeu de rôle est une forme d'art collaborative, une source inépuisable d'aventures et un moyen fantastique de créer des liens. Notre plateforme a été conçue par des passionnés, pour des passionnés, avec un objectif simple : éliminer les obstacles à l'organisation de parties. Fini les heures passées à chercher des joueurs compatibles ou un lieu pour se réunir. Nous centralisons tout ce dont vous avez besoin pour que vous puissiez vous concentrer sur l'essentiel : raconter des histoires inoubliables.
                    </p>
                </div>
        
                <div>
                    <h3 class="text-2xl font-bold text-white mb-6">L'Équipe</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="text-center">
                            <img src="https://placehold.co/128x128/374151/d1d5db?text=E" class="rounded-full w-32 h-32 mx-auto mb-4 border-4 border-indigo-500 object-cover">
                            <h4 class="text-xl font-bold text-white">Élise</h4>
                            <p class="text-indigo-400">Fondatrice & MJ Éternelle</p>
                        </div>
                        <div class="text-center">
                            <img src="https://placehold.co/128x128/374151/d1d5db?text=L" class="rounded-full w-32 h-32 mx-auto mb-4 border-4 border-indigo-500 object-cover">
                            <h4 class="text-xl font-bold text-white">Léo</h4>
                            <p class="text-indigo-400">Développeur & Barde Codeur</p>
                        </div>
                        <div class="text-center">
                            <img src="https://placehold.co/128x128/374151/d1d5db?text=C" class="rounded-full w-32 h-32 mx-auto mb-4 border-4 border-indigo-500 object-cover">
                            <h4 class="text-xl font-bold text-white">Chloé</h4>
                            <p class="text-indigo-400">Community Manager & Clerc</p>
                        </div>
                    </div>
                </div>
        
                <div class="mt-12 text-center pt-8 border-t border-gray-700">
                     <h3 class="text-2xl font-bold text-white mb-4">Rejoignez l'Aventure</h3>
                     <p class="text-gray-400 max-w-2xl mx-auto mb-8">
                         Bar à Dés est plus qu'un outil, c'est une communauté grandissante. Que vous soyez un vétéran aguerri ou un aventurier curieux, votre prochaine grande histoire vous attend.
                     </p>
                     <a href="#/sessions" class="btn-primary px-8 py-3 rounded-lg font-bold inline-flex items-center space-x-2 text-lg">
                        <i data-lucide="swords"></i>
                        <span>Trouver une partie</span>
                    </a>
                </div>
            </div>
        </section>

        <!-- "Nous Contacter" View -->
        <section id="contact-view" class="my-10 hidden">
            <div class="max-w-5xl mx-auto text-center">
                <h2 class="text-4xl font-extrabold text-white">Nous Contacter</h2>
                <p class="text-lg text-gray-400 mt-4 max-w-2xl mx-auto">
                    Une question, une suggestion ou un problème ? N'hésitez pas à nous envoyer un message. Notre équipe vous répondra dans les plus brefs délais.
                </p>
            </div>

            <div class="mt-12 grid grid-cols-1 lg:grid-cols-2 gap-12 items-start max-w-5xl mx-auto">
                <!-- Contact Form -->
                <div class="glass-card p-8">
                    <form id="contact-form" class="space-y-6">
                        <div>
                            <label for="contact-name" class="block text-sm font-medium text-gray-300 mb-2">Votre nom</label>
                            <input type="text" id="contact-name" name="name" required class="form-input" placeholder="Élise">
                        </div>
                        <div>
                            <label for="contact-email" class="block text-sm font-medium text-gray-300 mb-2">Votre email</label>
                            <input type="email" id="contact-email" name="email" required class="form-input" placeholder="elise@barades.com">
                        </div>
                        <div>
                            <label for="contact-subject" class="block text-sm font-medium text-gray-300 mb-2">Sujet</label>
                            <input type="text" id="contact-subject" name="subject" required class="form-input" placeholder="Suggestion de fonctionnalité">
                        </div>
                        <div>
                            <label for="contact-message" class="block text-sm font-medium text-gray-300 mb-2">Votre message</label>
                            <textarea id="contact-message" name="message" rows="5" required class="form-input" placeholder="Bonjour, je pense qu'il serait utile d'ajouter..."></textarea>
                        </div>
                        <div>
                            <button type="submit" class="btn-primary w-full py-3 rounded-lg font-bold flex items-center justify-center space-x-2">
                                <i data-lucide="send"></i>
                                <span>Envoyer le message</span>
                            </button>
                        </div>
                        <div id="contact-form-feedback" class="text-center h-5"></div>
                    </form>
                </div>

                <!-- Contact Info & Map -->
                <div class="space-y-8">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold text-white mb-4">Informations</h3>
                        <ul class="space-y-4 text-gray-300">
                            <li class="flex items-start">
                                <i data-lucide="map-pin" class="w-5 h-5 mr-4 mt-1 text-indigo-400"></i>
                                <span>Bar à Dés HQ<br>Grand Place, 7500 Tournai<br>Belgique</span>
                            </li>
                            <li class="flex items-start">
                                <i data-lucide="mail" class="w-5 h-5 mr-4 mt-1 text-indigo-400"></i>
                                <a href="mailto:contact@barades.com" class="hover:text-indigo-400">contact@barades.com</a>
                            </li>
                        </ul>
                    </div>
                    <div class="glass-card h-80 w-full overflow-hidden">
                        <div id="contact-map" class="h-full w-full"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- "Carrières" View -->
        <section id="careers-view" class="my-10 hidden">
            <div class="max-w-5xl mx-auto text-center">
                <h2 class="text-4xl font-extrabold text-white">Rejoignez l'Aventure</h2>
                <p class="text-lg text-gray-400 mt-4 max-w-3xl mx-auto">
                    Nous cherchons des passionnés talentueux pour nous aider à construire la meilleure plateforme pour les rôlistes. Si vous aimez les dés, les histoires et le code, vous êtes au bon endroit.
                </p>
            </div>
        
            <div class="mt-16 max-w-5xl mx-auto">
                <h3 class="text-2xl font-bold text-white mb-8 text-center sm:text-left">Postes Ouverts</h3>
                <div class="space-y-6">
                    <!-- Job Opening 1 -->
                    <div class="glass-card p-6 flex flex-col sm:flex-row justify-between items-center gap-4 transition-all duration-300 hover:border-indigo-500">
                        <div>
                            <h4 class="text-xl font-bold text-white">Développeur / Développeuse Full-Stack</h4>
                            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-400 mt-2">
                                <span class="flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>Tournai, Belgique (Hybride)</span>
                                <span class="flex items-center"><i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>Temps Plein</span>
                            </div>
                        </div>
                        <button class="btn-primary px-5 py-2 rounded-lg font-semibold w-full sm:w-auto">Postuler</button>
                    </div>
                    <!-- Job Opening 2 -->
                    <div class="glass-card p-6 flex flex-col sm:flex-row justify-between items-center gap-4 transition-all duration-300 hover:border-indigo-500">
                        <div>
                            <h4 class="text-xl font-bold text-white">Community Manager (Francophone)</h4>
                             <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-400 mt-2">
                                <span class="flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>Télétravail</span>
                                <span class="flex items-center"><i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>Temps Plein</span>
                            </div>
                        </div>
                        <button class="btn-primary px-5 py-2 rounded-lg font-semibold w-full sm:w-auto">Postuler</button>
                    </div>
                     <!-- Job Opening 3 -->
                    <div class="glass-card p-6 flex flex-col sm:flex-row justify-between items-center gap-4 transition-all duration-300 hover:border-indigo-500">
                        <div>
                            <h4 class="text-xl font-bold text-white">Maître de Jeu Professionnel & Créateur de Contenu</h4>
                            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-400 mt-2">
                                <span class="flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>Télétravail</span>
                                <span class="flex items-center"><i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>Freelance / Partenariat</span>
                            </div>
                        </div>
                        <button class="btn-secondary px-5 py-2 rounded-lg font-semibold w-full sm:w-auto">En savoir plus</button>
                    </div>
                </div>
            </div>
            
             <div class="mt-20 max-w-5xl mx-auto">
                <h3 class="text-2xl font-bold text-white mb-8 text-center">Pourquoi nous rejoindre ?</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                    <div class="glass-card p-6">
                        <i data-lucide="shield-check" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                        <h4 class="text-lg font-bold text-white mb-2">Impact Direct</h4>
                        <p class="text-sm text-gray-400">Votre travail aidera des milliers de joueurs à vivre leur passion.</p>
                    </div>
                     <div class="glass-card p-6">
                        <i data-lucide="users" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                        <h4 class="text-lg font-bold text-white mb-2">Culture Passionnée</h4>
                        <p class="text-sm text-gray-400">Rejoignez une équipe qui vit et respire le jeu de rôle.</p>
                    </div>
                     <div class="glass-card p-6">
                        <i data-lucide="gem" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                        <h4 class="text-lg font-bold text-white mb-2">Avantages Uniques</h4>
                        <p class="text-sm text-gray-400">Budget pour matériel de JDR, flexibilité et plus encore.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- "Charte" View -->
        <section id="charter-view" class="my-10 hidden">
             <div class="max-w-4xl mx-auto">
                <div class="text-center">
                    <h2 class="text-4xl font-extrabold text-white">Charte de la Communauté</h2>
                    <p class="text-lg text-gray-400 mt-4">
                        Les règles d'or pour garantir que Bar à Dés reste un espace sûr, accueillant et amusant pour tous les aventuriers.
                    </p>
                </div>

                <div class="mt-12 space-y-10">
                    <div class="glass-card p-8">
                        <h3 class="text-2xl font-bold text-white mb-4 flex items-center"><i data-lucide="heart" class="w-6 h-6 mr-3 text-indigo-400"></i>1. La Bienveillance avant tout</h3>
                        <p class="text-gray-300">
                            Le jeu de rôle est une activité sociale. Traitez chaque membre de la communauté avec gentillesse et empathie. Les débutants sont les bienvenus, les vétérans sont encouragés à partager leur savoir. Toute forme de harcèlement, d'intimidation ou de discours haineux est strictement interdite.
                        </p>
                    </div>
                    <div class="glass-card p-8">
                        <h3 class="text-2xl font-bold text-white mb-4 flex items-center"><i data-lucide="scale" class="w-6 h-6 mr-3 text-indigo-400"></i>2. Le Respect des différences</h3>
                        <p class="text-gray-300">
                            Notre communauté est diverse. Respectez les opinions, les styles de jeu, les personnages et les histoires des autres, même s'ils diffèrent des vôtres. La critique constructive est acceptable, le dénigrement ne l'est pas.
                        </p>
                    </div>
                    <div class="glass-card p-8">
                        <h3 class="text-2xl font-bold text-white mb-4 flex items-center"><i data-lucide="handshake" class="w-6 h-6 mr-3 text-indigo-400"></i>3. L'Inclusivité à chaque table</h3>
                        <p class="text-gray-300">
                            Nous nous engageons à être un espace inclusif pour tous, sans distinction d'âge, de sexe, d'identité de genre, d'orientation sexuelle, de handicap, d'origine ethnique, de religion ou de niveau d'expérience. Créez des tables ouvertes et accueillantes.
                        </p>
                    </div>
                    <div class="glass-card p-8">
                        <h3 class="text-2xl font-bold text-white mb-4 flex items-center"><i data-lucide="calendar-check" class="w-6 h-6 mr-3 text-indigo-400"></i>4. L'Engagement et la Communication</h3>
                        <p class="text-gray-300">
                            Lorsque vous vous engagez dans une partie, vous vous engagez envers votre groupe. Soyez ponctuel et prévenez le plus tôt possible en cas d'absence. Une bonne communication est la clé de sessions réussies et de groupes soudés.
                        </p>
                    </div>
                    <div class="glass-card p-8">
                        <h3 class="text-2xl font-bold text-white mb-4 flex items-center"><i data-lucide="shield" class="w-6 h-6 mr-3 text-indigo-400"></i>5. La Sécurité et le Consentement</h3>
                        <p class="text-gray-300">
                           Le jeu de rôle peut aborder des thèmes matures. Il est crucial de discuter des limites et des attentes avant de commencer une partie (Session 0). Des outils comme la X-Card sont encouragés pour assurer le confort de tous les joueurs pendant le jeu. Respectez toujours le "non" d'un joueur.
                        </p>
                    </div>
                    <div class="glass-card p-8 border-red-500/50">
                        <h3 class="text-2xl font-bold text-white mb-4 flex items-center"><i data-lucide="gavel" class="w-6 h-6 mr-3 text-red-400"></i>Conséquences</h3>
                        <p class="text-gray-300">
                           Tout manquement à cette charte pourra entraîner un avertissement, une suspension temporaire ou un bannissement permanent de la plateforme, à la discrétion de l'équipe de modération. Si vous êtes témoin ou victime d'un comportement inapproprié, veuillez le signaler immédiatement via notre <a href="#/contact" class="text-indigo-400 underline">page de contact</a>.
                        </p>
                    </div>
                </div>
             </div>
        </section>

        <!-- "Forum" View -->
        <section id="forum-view" class="my-10 hidden">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                <h2 class="text-3xl font-bold text-white">Forum de la Communauté</h2>
                <button class="btn-primary px-5 py-2 rounded-lg font-semibold flex items-center justify-center space-x-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Nouveau Sujet</span>
                </button>
            </div>
            <div id="forum-content" class="space-y-8">
                <!-- Forum categories and topics will be injected here -->
            </div>
        </section>

        <!-- "Aide" (FAQ) View -->
        <section id="help-view" class="my-10 hidden">
             <div class="max-w-4xl mx-auto text-center">
                <h2 class="text-4xl font-extrabold text-white">Centre d'Aide</h2>
                <p class="text-lg text-gray-400 mt-4">Comment pouvons-nous vous aider ?</p>
                <div class="relative mt-8 max-w-2xl mx-auto">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="search" id="faq-search" placeholder="Rechercher une question (ex: 'profil', 'créer un groupe')..." class="form-input pl-12 py-3">
                </div>
            </div>

            <div id="faq-container" class="max-w-4xl mx-auto mt-12 space-y-8">
                <!-- FAQ items will be injected here -->
            </div>

            <div id="no-faq-found" class="hidden text-center glass-card p-12 max-w-4xl mx-auto mt-12">
                <i data-lucide="help-circle" class="w-24 h-24 text-indigo-400 mx-auto mb-6"></i>
                <h3 class="text-2xl font-bold text-white mb-2">Aucun résultat</h3>
                <p class="text-gray-400 mb-6">Nous n'avons pas trouvé de réponse à votre question. Essayez avec d'autres mots-clés ou contactez notre support.</p>
                <a href="#/contact" class="btn-primary px-6 py-3 rounded-lg font-bold">
                    Contacter le support
                </a>
            </div>
        </section>

        <!-- "Group Detail" View -->
        <div id="group-detail-view" class="hidden">
            <!-- Group detail content will be injected here -->
        </div>

        <!-- "Profile" View -->
        <section id="profile-view" class="my-10 hidden">
            <div class="max-w-4xl mx-auto">
                 <div class="text-center mb-12">
                    <h2 class="text-4xl font-extrabold text-white">Mon Profil</h2>
                    <p class="text-lg text-gray-400 mt-4">Mettez à jour vos informations personnelles.</p>
                </div>
                <form id="profile-form" class="glass-card p-8 grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
                    <!-- Avatar Section -->
                    <div class="md:col-span-1 flex flex-col items-center">
                        <img id="profile-avatar-preview" src="" alt="Aperçu de l'avatar" class="rounded-full w-40 h-40 object-cover mb-4 border-4 border-gray-600">
                        <input type="file" id="profile-avatar-input" class="hidden" accept="image/*">
                        <label for="profile-avatar-input" class="btn-secondary text-center w-full cursor-pointer px-4 py-2 rounded-lg font-semibold">
                            Changer l'avatar
                        </label>
                    </div>

                    <!-- Info Section -->
                    <div class="md:col-span-2 space-y-6">
                        <div>
                            <label for="profile-username" class="block text-sm font-medium text-gray-300 mb-2">Nom d'utilisateur</label>
                            <input type="text" id="profile-username" required class="form-input">
                        </div>
                         <div>
                            <label for="profile-email" class="block text-sm font-medium text-gray-300 mb-2">Email (non modifiable)</label>
                            <input type="email" id="profile-email" disabled class="form-input bg-gray-800/50 cursor-not-allowed">
                        </div>
                        <div>
                            <label for="profile-bio" class="block text-sm font-medium text-gray-300 mb-2">Biographie</label>
                            <textarea id="profile-bio" rows="4" class="form-textarea" placeholder="Parlez un peu de vous, de vos jeux préférés..."></textarea>
                        </div>
                        <div id="profile-feedback" class="h-5 text-center"></div>
                        <div class="flex justify-end">
                             <button type="submit" class="btn-primary px-6 py-3 rounded-lg font-bold">
                                Enregistrer les modifications
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- Standalone Planning View -->
        <section id="planning-view" class="my-10 hidden">
            <!-- Content will be injected by JS -->
        </section>

        <!-- "Devenir Partenaire" View -->
        <section id="partner-view" class="my-10 hidden">
            <div class="max-w-4xl mx-auto text-center">
                <h2 class="text-4xl font-extrabold text-white">Devenez Partenaire</h2>
                <p class="text-lg text-gray-400 mt-4">
                    Rejoignez notre réseau et connectez-vous avec une communauté passionnée de rôlistes.
                </p>
            </div>

            <div class="mt-16 max-w-5xl mx-auto">
                <h3 class="text-2xl font-bold text-white mb-8 text-center">Pourquoi devenir partenaire de Bar à Dés ?</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                    <div class="glass-card p-8">
                        <i data-lucide="eye" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                        <h4 class="text-lg font-bold text-white mb-2">Visibilité Accrue</h4>
                        <p class="text-sm text-gray-400">Présentez votre établissement, association ou boutique à des milliers de joueurs actifs à la recherche de lieux de jeu.</p>
                    </div>
                     <div class="glass-card p-8">
                        <i data-lucide="users" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                        <h4 class="text-lg font-bold text-white mb-2">Nouveaux Clients</h4>
                        <p class="text-sm text-gray-400">Attirez de nouveaux clients et membres en figurant sur notre carte interactive et en hébergeant des parties.</p>
                    </div>
                     <div class="glass-card p-8">
                        <i data-lucide="calendar-plus" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                        <h4 class="text-lg font-bold text-white mb-2">Organisation d'Événements</h4>
                        <p class="text-sm text-gray-400">Utilisez notre plateforme pour promouvoir vos événements, tournois et soirées thématiques auprès d'un public ciblé.</p>
                    </div>
                </div>
            </div>

            <div class="mt-20 max-w-4xl mx-auto glass-card p-8">
                <h3 class="text-2xl font-bold text-white mb-6 text-center">Qui peut devenir partenaire ?</h3>
                <ul class="space-y-4 text-gray-300">
                    <li class="flex items-start"><i data-lucide="sword" class="w-6 h-6 mr-4 mt-1 text-indigo-400"></i><div><strong class="text-white">Bars à jeux et cafés ludiques :</strong> Devenez le point de rendez-vous incontournable des rôlistes de votre ville.</div></li>
                    <li class="flex items-start"><i data-lucide="store" class="w-6 h-6 mr-4 mt-1 text-indigo-400"></i><div><strong class="text-white">Boutiques spécialisées :</strong> Mettez en avant votre magasin, vos produits et vos tables de jeu.</div></li>
                    <li class="flex items-start"><i data-lucide="home" class="w-6 h-6 mr-4 mt-1 text-indigo-400"></i><div><strong class="text-white">Associations et clubs de JDR :</strong> Gagnez en visibilité, recrutez de nouveaux membres et organisez vos parties plus facilement.</div></li>
                    <li class="flex items-start"><i data-lucide="dice-6" class="w-6 h-6 mr-4 mt-1 text-indigo-400"></i><div><strong class="text-white">Créateurs de contenu et éditeurs :</strong> Collaborez avec nous pour promouvoir vos jeux, actual plays et autres créations.</div></li>
                </ul>
            </div>
            
            <div class="mt-20 max-w-2xl mx-auto">
                 <div class="text-center mb-8">
                    <h3 class="text-3xl font-bold text-white">Contactez-nous</h3>
                    <p class="text-gray-400 mt-2">Remplissez le formulaire ci-dessous et notre équipe vous recontactera pour discuter des possibilités de partenariat.</p>
                </div>
                <form id="partner-form" class="glass-card p-8 space-y-6">
                    <div>
                        <label for="partner-name" class="block text-sm font-medium text-gray-300 mb-2">Nom de l'établissement / Organisation</label>
                        <input type="text" id="partner-name" required class="form-input">
                    </div>
                    <div>
                        <label for="partner-contact-name" class="block text-sm font-medium text-gray-300 mb-2">Votre nom</label>
                        <input type="text" id="partner-contact-name" required class="form-input">
                    </div>
                    <div>
                        <label for="partner-email" class="block text-sm font-medium text-gray-300 mb-2">Votre email</label>
                        <input type="email" id="partner-email" required class="form-input">
                    </div>
                    <div>
                        <label for="partner-message" class="block text-sm font-medium text-gray-300 mb-2">Votre message</label>
                        <textarea id="partner-message" rows="4" class="form-textarea" placeholder="Présentez-nous brièvement votre projet et vos attentes..."></textarea>
                    </div>
                    <div id="partner-form-feedback" class="text-center h-5"></div>
                    <div>
                        <button type="submit" class="btn-primary w-full py-3 rounded-lg font-bold">Envoyer la demande</button>
                    </div>
                </form>
            </div>
        </section>

    </main>
    
    <!-- Modal for Creating a New Poll -->
    <div id="poll-modal" class="modal-overlay">
        <div class="modal-content glass-card w-full max-w-lg p-8 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Créer un sondage</h3>
                <button data-action="close-modal" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="poll-form">
                <div class="mb-4">
                    <label for="poll-title" class="block text-sm font-medium text-gray-300 mb-2">Titre du sondage</label>
                    <input type="text" id="poll-title" class="form-input" placeholder="Ex: Session de Novembre" required>
                </div>
                <div class="mb-6">
                    <label for="poll-dates-input" class="block text-sm font-medium text-gray-300 mb-2">Dates proposées</label>
                    <input type="text" id="poll-dates-input" class="form-input" placeholder="Cliquez pour choisir les dates..." readonly>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" data-action="close-modal" class="btn-secondary px-6 py-2 rounded-lg">Annuler</button>
                    <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Créer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content glass-card w-full max-w-md p-8 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Connexion</h3>
                <button data-action="close-modal" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="login-email" required class="form-input" placeholder="votre@email.com">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Mot de passe</label>
                    <input type="password" id="login-password" required class="form-input" placeholder="********">
                </div>
                <div id="login-error" class="text-red-400 text-sm text-center h-4"></div>
                <div>
                    <button type="submit" class="btn-primary w-full py-3 rounded-lg font-bold">Se connecter</button>
                </div>
                <p class="text-sm text-center text-gray-400">
                    Pas encore de compte ? <a href="#" data-action="open-register" class="font-semibold text-indigo-400 hover:underline">Inscrivez-vous</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="register-modal" class="modal-overlay">
        <div class="modal-content glass-card w-full max-w-md p-8 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Créer un compte</h3>
                <button data-action="close-modal" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="register-form" class="space-y-6">
                <div>
                    <label for="register-username" class="block text-sm font-medium text-gray-300 mb-2">Nom d'utilisateur</label>
                    <input type="text" id="register-username" required class="form-input" placeholder="AventurierDuDimanche">
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="register-email" required class="form-input" placeholder="votre@email.com">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-300 mb-2">Mot de passe</label>
                    <input type="password" id="register-password" required class="form-input" placeholder="********">
                </div>
                <div id="register-error" class="text-red-400 text-sm text-center h-4"></div>
                <div>
                    <button type="submit" class="btn-primary w-full py-3 rounded-lg font-bold">S'inscrire</button>
                </div>
                 <p class="text-sm text-center text-gray-400">
                    Déjà un compte ? <a href="#" data-action="open-login" class="font-semibold text-indigo-400 hover:underline">Connectez-vous</a>
                </p>
            </form>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-700">
        <div class="container mx-auto px-4 lg:px-6 py-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div>
                    <h4 class="font-bold text-white mb-3">Bar à Dés</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="#/about" class="hover:text-indigo-400">À propos</a></li>
                        <li><a href="#/contact" class="hover:text-indigo-400">Nous contacter</a></li>
                        <li><a href="#/careers" class="hover:text-indigo-400">Carrières</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-white mb-3">Communauté</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="#/charter" class="hover:text-indigo-400">Charte</a></li>
                        <li><a href="#/forum" class="hover:text-indigo-400">Forum</a></li>
                        <li><a href="#" class="hover:text-indigo-400">Discord</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-white mb-3">Ressources</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="#/help" class="hover:text-indigo-400">Aide</a></li>
                        <li><a href="#/partner" class="hover:text-indigo-400">Devenir partenaire</a></li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-bold text-white mb-3">Légal</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="#" class="hover:text-indigo-400">Confidentialité</a></li>
                        <li><a href="#" class="hover:text-indigo-400">Conditions d'utilisation</a></li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-gray-700 flex flex-col sm:flex-row justify-between items-center">
                <p class="text-sm text-gray-500">&copy; 2025 barades.com. Tous droits réservés.</p>
                <div class="flex space-x-4 mt-4 sm:mt-0">
                    <a href="#" class="text-gray-400 hover:text-indigo-400"><i data-lucide="twitter"></i></a>
                    <a href="#" class="text-gray-400 hover:text-indigo-400"><i data-lucide="instagram"></i></a>
                    <a href="#" class="text-gray-400 hover:text-indigo-400"><i data-lucide="facebook"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Service Worker Script -->
    <script id="sw-script" type="application/javascript">
        const CACHE_NAME = 'barades-cache-v1';
        const urlsToCache = [
            '/',
            'https://cdn.tailwindcss.com',
            'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',
            'https://unpkg.com/lucide@latest',
            'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
            'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
        ];

        self.addEventListener('install', event => {
            event.waitUntil(
                caches.open(CACHE_NAME)
                .then(cache => {
                    console.log('Opened cache');
                    return cache.addAll(urlsToCache);
                })
            );
        });

        self.addEventListener('fetch', event => {
            event.respondWith(
                caches.match(event.request)
                .then(response => {
                    if (response) {
                        return response;
                    }
                    return fetch(event.request);
                })
            );
        });

        self.addEventListener('activate', event => {
          const cacheWhitelist = [CACHE_NAME];
          event.waitUntil(
            caches.keys().then(cacheNames => {
              return Promise.all(
                cacheNames.map(cacheName => {
                  if (cacheWhitelist.indexOf(cacheName) === -1) {
                    return caches.delete(cacheName);
                  }
                })
              );
            })
          );
        });
    </script>
    
    <!-- Main App Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- MOCK DATABASES & DATA HANDLING ---
            let allUsers = [];
            const defaultUsers = [
                { username: "Elara", email: "elara@barades.com", password: "password123", bio: "MJ passionnée par les mondes fantastiques et les histoires épiques. Toujours partante pour une nouvelle campagne !", avatar: "" },
                { username: "Victor", email: "victor@barades.com", password: "password123", bio: "Amateur de JDR d'horreur et d'enquête. L'Appel de Cthulhu est mon jeu de prédilection.", avatar: "" },
                { username: "Membre 2", email: "membre2@test.com", password: "password123", bio: "", avatar: "" }
            ];
            
            const saveUsersToStorage = () => localStorage.setItem('barades_users', JSON.stringify(allUsers));
            const loadUsersFromStorage = () => {
                const usersFromStorage = localStorage.getItem('barades_users');
                allUsers = usersFromStorage ? JSON.parse(usersFromStorage) : defaultUsers;
                if (!usersFromStorage) saveUsersToStorage();
            };
            
            let allPolls = [];
            const savePollsToStorage = () => localStorage.setItem('barades_polls', JSON.stringify(allPolls));
            const loadPollsFromStorage = () => {
                const pollsFromStorage = localStorage.getItem('barades_polls');
                allPolls = pollsFromStorage ? JSON.parse(pollsFromStorage) : [];
            };

            let allSessions = [
                { id: 1, game: "Dungeons & Dragons 5e", title: "Le Tombeau de l'Annihilation", mj: "Elara", date: "Sam. 12 Octobre - 20h00", location: "Bar \"Le Dé Pipé\", Paris", level: "Intermédiaire", players_current: 3, players_max: 5, online: false, tagColor: "red" },
                { id: 2, game: "L'Appel de Cthulhu", title: "Les Masques de Nyarlathotep", mj: "Victor", date: "Ven. 18 Octobre - 21h00", location: "En Ligne (Discord/Roll20)", level: "Ouvert à tous", players_current: 2, players_max: 4, online: true, tagColor: "green" },
                { id: 3, game: "Cyberpunk RED", title: "Mission à Night City", mj: "Jack", date: "Dim. 20 Octobre - 14h00", location: "Lieu privé, Lyon", level: "Expérimentés", players_current: 4, players_max: 4, online: false, tagColor: "purple" },
                { id: 4, game: "Vampire: La Mascarade", title: "Chroniques de Bruxelles", mj: "Isabelle", date: "Mar. 15 Octobre - 19h30", location: "L'Antre du Dragon, Bruxelles", level: "Débutants bienvenus", players_current: 1, players_max: 5, online: false, tagColor: "gray" },
                { id: 5, game: "Dungeons & Dragons 5e", title: "La Mine Perdue de Phandelver", mj: "Thomas", date: "Jeu. 17 Octobre - 20h00", location: "En Ligne (FoundryVTT)", level: "Débutant", players_current: 4, players_max: 5, online: true, tagColor: "red" },
                { id: 6, game: "Pathfinder 2e", title: "L'Ère des Cendres", mj: "Aline", date: "Sam. 19 Octobre - 14h00", location: "Warzone, Tournai", level: "Intermédiaire", players_current: 3, players_max: 6, online: false, tagColor: "blue" },
            ];
            let allLocations = [
                { id: 1, name: "Le Dé Pipé", city: "Paris", type: "Bar à jeux", rating: 4.5, amenities: ["Nourriture", "Boissons", "Tables privées"], icon: "sword", lat: 48.8566, lon: 2.3522 },
                { id: 2, name: "La Taverne du Joueur", city: "Lyon", type: "Café ludique", rating: 4.0, amenities: ["Boissons", "Snacks"], icon: "coffee", lat: 45.7640, lon: 4.8357 },
                { id: 3, name: "Warzone", city: "Tournai", type: "Boutique", rating: 5.0, amenities: ["Tables de jeu", "Vente de matériel", "Accessible PMR"], icon: "shopping-cart", lat: 50.6052, lon: 3.3879 },
                { id: 4, name: "L'Antre du Dragon", city: "Bruxelles", type: "Association", rating: 4.0, amenities: ["Tables de jeu", "Ludothèque"], icon: "users", lat: 50.8503, lon: 4.3517 },
                { id: 5, name: "The Dice Latte", city: "Lille", type: "Café ludique", rating: 4.5, amenities: ["Nourriture", "Boissons", "Café de spécialité"], icon: "coffee", lat: 50.6292, lon: 3.0573 },
            ];
            let allGroups = [
                { id: 1, name: "Les Gardiens de la Côte", games: ["Dungeons & Dragons 5e", "Pathfinder 2e"], location: "Lille", members: 5, recruiting: true, playstyle: "Sérieux", description: "Groupe axé sur des campagnes longues et immersives. Nous cherchons des joueurs motivés pour des sessions hebdomadaires.", avatar: "LG", schedule_polls: [
                    {
                        id: 1,
                        title: "Session d'Octobre",
                        dates: ["2025-10-15", "2025-10-17", "2025-10-18", "2025-10-19"],
                        votes: {
                            "2025-10-15": ["Membre 1 (Admin)", "Membre 3"],
                            "2025-10-17": ["Membre 2", "Membre 3"],
                            "2025-10-18": ["Membre 1 (Admin)", "Membre 2", "Membre 3"],
                            "2025-10-19": ["Membre 2"]
                        }
                    }
                ]},
                { id: 2, name: "Explorateurs de Night City", games: ["Cyberpunk RED", "Shadowrun"], location: "En Ligne", members: 8, recruiting: false, playstyle: "Fun & Action", description: "Ambiance décontractée, on est là pour s'amuser et faire exploser des trucs. Sessions bimensuelles sur Discord.", avatar: "EN", schedule_polls: [] },
                { id: 3, name: "Les Investigateurs de l'Étrange", games: ["L'Appel de Cthulhu", "Vampire: La Mascarade"], location: "Lyon", members: 4, recruiting: true, playstyle: "Découverte", description: "Ouvert aux débutants pour découvrir des jeux d'ambiance et d'enquête. La bienveillance est notre maître-mot.", avatar: "IE", schedule_polls: [] },
                { id: 4, name: "La Guilde des Mercenaires", games: ["Warhammer", "The Witcher RPG"], location: "Bruxelles", members: 6, recruiting: true, playstyle: "Sérieux", description: "Campagnes difficiles dans des univers sombres et matures. Joueurs expérimentés recherchés.", avatar: "GM", schedule_polls: [] },
            ];
            let forumTopics = [
                { id: 1, category: "Règles et Aides de jeu", title: "Clarification sur la magie sauvage (D&D 5e)", author: "Elara", replies: 12, lastPost: { author: "Victor", time: "il y a 2 heures" } },
                { id: 2, category: "Règles et Aides de jeu", title: "Meilleures fiches de perso pour Cthulhu ?", author: "Thomas", replies: 5, lastPost: { author: "Isabelle", time: "il y a 8 heures" } },
                { id: 3, category: "Recherche de Joueurs & Groupes", title: "[LFP][En Ligne] Campagne 'Curse of Strahd'", author: "Jack", replies: 25, lastPost: { author: "Aline", time: "il y a 25 minutes" } },
                { id: 4, category: "Recherche de Joueurs & Groupes", title: "[Table][Paris] Cherche 2 joueurs pour one-shot Cyberpunk", author: "MJ-Paris", replies: 8, lastPost: { author: "Chloé", time: "il y a 3 jours" } },
                { id: 5, category: "Histoires de Parties", title: "Votre plus grand moment de roleplay ?", author: "Aline", replies: 56, lastPost: { author: "Léo", time: "il y a 5 minutes" } },
                { id: 6, category: "Discussions Générales", title: "Quel est le prochain JDR que vous voulez tester ?", author: "Victor", replies: 34, lastPost: { author: "Elara", time: "hier" } },
            ];
            let helpFaqs = [
                { category: "Compte et Profil", question: "Comment modifier mon profil et mon avatar ?", answer: "Pour modifier votre profil, cliquez sur votre nom d'utilisateur en haut à droite, puis sélectionnez 'Mon Profil'. Vous pourrez y changer votre pseudo, votre biographie et télécharger un nouvel avatar." },
                { category: "Compte et Profil", question: "J'ai oublié mon mot de passe, que faire ?", answer: "Sur la page de connexion, cliquez sur le lien 'Mot de passe oublié'. Entrez votre adresse e-mail et nous vous enverrons un lien pour réinitialiser votre mot de passe." },
                { category: "Trouver et Gérer des Parties", question: "Comment créer une session de jeu ?", answer: "Rendez-vous sur la page 'Trouver une Partie' et cliquez sur le bouton 'Créer une session'. Remplissez les détails de votre partie : jeu, titre, date, lieu, nombre de joueurs, etc. Une fois publiée, les autres membres pourront la voir et postuler." },
                { category: "Trouver et Gérer des Parties", question: "Comment postuler à une partie ?", answer: "Lorsque vous trouvez une partie qui vous intéresse, cliquez sur 'Rejoindre' ou 'Voir les détails'. Sur la page de la session, vous trouverez un bouton pour envoyer votre candidature au Maître de Jeu (MJ). Vous pouvez y joindre un petit message de présentation." },
                { category: "Groupes et Communauté", question: "Quelle est la différence entre un groupe et une session ?", answer: "Une 'session' est une partie unique, planifiée à une date précise. Un 'groupe' est une communauté de joueurs qui se retrouvent régulièrement, souvent pour des campagnes longues. Vous pouvez rejoindre un groupe pour trouver des partenaires de jeu sur le long terme." },
                { category: "Utilisation des Outils", question: "Le lanceur de dés est-il vraiment aléatoire ?", answer: "Oui ! Notre lanceur de dés utilise un algorithme de génération de nombres pseudo-aléatoires de haute qualité (Mersenne Twister) pour garantir des résultats aussi justes et imprévisibles que de vrais dés." },
            ];
            
            // --- GLOBAL AUTH STATE ---
            let currentUser = null;
            
            // --- DOM ELEMENTS ---
            const mainContent = document.getElementById('main-content');
            const findSessionView = document.getElementById('find-session-view');
            const findLocationView = document.getElementById('find-location-view');
            const findGroupsView = document.getElementById('find-groups-view');
            const groupDetailView = document.getElementById('group-detail-view');
            const toolsView = document.getElementById('tools-view');
            const aboutView = document.getElementById('about-view');
            const contactView = document.getElementById('contact-view');
            const careersView = document.getElementById('careers-view');
            const charterView = document.getElementById('charter-view');
            const forumView = document.getElementById('forum-view');
            const helpView = document.getElementById('help-view');
            const profileView = document.getElementById('profile-view');
            const planningView = document.getElementById('planning-view');
            const partnerView = document.getElementById('partner-view');

            
            // Modals
            const pollModal = document.getElementById('poll-modal');
            const loginModal = document.getElementById('login-modal');
            const registerModal = document.getElementById('register-modal');
            const allModals = [pollModal, loginModal, registerModal];
            
            // Header Auth elements
            const authLinks = document.getElementById('auth-links');
            const userMenu = document.getElementById('user-menu');
            const usernameDisplay = document.getElementById('username-display');
            const userAvatar = document.getElementById('user-avatar');

            // "Trouver une Partie" Page
            const sessionsGrid = document.getElementById('sessions-grid');
            const noSessionsMessage = document.getElementById('no-sessions-found');
            const filterKeyword = document.getElementById('filter-keyword');
            const filterGameSystem = document.getElementById('filter-game-system');
            const filterLocation = document.getElementById('filter-location');
            const filterAvailability = document.getElementById('filter-availability');
            const filterLocationTypeRadios = document.querySelectorAll('input[name="location-type"]');
            
            // "Lieux de Jeu" Page
            const locationsList = document.getElementById('locations-list');
            const noLocationsMessage = document.getElementById('no-locations-found');
            const filterLocationKeyword = document.getElementById('filter-location-keyword');
            const filterLocationType = document.getElementById('filter-location-type');
            const filterLocationAmenities = document.getElementById('filter-location-amenities');

            // "Trouver un Groupe" Page
            const groupsGrid = document.getElementById('groups-grid');
            const noGroupsMessage = document.getElementById('no-groups-found');
            const filterGroupKeyword = document.getElementById('filter-group-keyword');
            const filterGroupGame = document.getElementById('filter-group-game');
            const filterGroupLocation = document.getElementById('filter-group-location');
            const filterGroupPlaystyle = document.getElementById('filter-group-playstyle');
            const filterGroupRecruiting = document.getElementById('filter-group-recruiting');
            
            // Poll Modal Form
            const pollForm = document.getElementById('poll-form');
            const pollDatesContainer = document.getElementById('poll-dates-container');


            // --- MAP VARIABLES ---
            let map = null;
            let contactMap = null;
            let markersLayer = null;

            // --- UI FUNCTIONS ---
            const showView = (viewToShow) => {
                [mainContent, findSessionView, findLocationView, findGroupsView, groupDetailView, toolsView, aboutView, contactView, careersView, charterView, forumView, helpView, profileView, planningView, partnerView].forEach(view => {
                    if (view === viewToShow) {
                        view.classList.remove('hidden');
                    } else {
                        view.classList.add('hidden');
                    }
                });
                if (viewToShow === findLocationView && map) {
                    setTimeout(() => map.invalidateSize(), 0);
                }
                if (viewToShow === contactView) {
                    setTimeout(() => contactMap?.invalidateSize(), 0);
                }
                window.scrollTo(0,0);
            };

            const createSessionCardHTML = (session) => {
                const isFull = session.players_current >= session.players_max;
                const tagColors = { red: 'bg-red-800 text-red-100', green: 'bg-green-800 text-green-100', purple: 'bg-purple-800 text-purple-100', gray: 'bg-gray-700 text-gray-200', blue: 'bg-blue-800 text-blue-100' };

                return `
                <div class="glass-card p-6 flex flex-col hover:border-indigo-500 transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="tag ${tagColors[session.tagColor] || 'bg-gray-700'}">${session.game}</span>
                            <h3 class="text-xl font-bold text-white mt-2">${session.title}</h3>
                        </div>
                        <div class="text-center">
                            <img src="https://placehold.co/48x48/4338ca/ffffff?text=MJ" alt="Avatar du MJ" class="rounded-full mx-auto">
                            <span class="text-xs text-gray-400 mt-1 block">${session.mj}</span>
                        </div>
                    </div>
                    <div class="space-y-3 text-sm text-gray-300 mb-4 flex-grow">
                        <p class="flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-indigo-400"></i> ${session.date}</p>
                        <p class="flex items-center"><i data-lucide="${session.online ? 'globe' : 'map-pin'}" class="w-4 h-4 mr-2 text-indigo-400"></i> ${session.location}</p>
                        <p class="flex items-center"><i data-lucide="user-check" class="w-4 h-4 mr-2 text-indigo-400"></i> Niveau : ${session.level}</p>
                    </div>
                    <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-700">
                        <div class="flex items-center space-x-1">
                            <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                            <span class="font-semibold text-white">${isFull ? 'COMPLET' : `${session.players_current} / ${session.players_max} joueurs`}</span>
                        </div>
                        <button class="${isFull ? 'btn-secondary' : 'btn-primary'} px-4 py-2 rounded-lg text-sm font-semibold" ${isFull ? 'disabled' : ''}>${isFull ? 'Complet' : 'Rejoindre'}</button>
                    </div>
                </div>`;
            };
            const createLocationCardHTML = (location) => {
                const rating = location.rating;
                let starsHTML = '';
                for(let i = 1; i <= 5; i++) {
                    if (i <= rating) starsHTML += `<i data-lucide="star" class="w-4 h-4 fill-current"></i>`;
                    else if (i - 0.5 <= rating) starsHTML += `<i data-lucide="star-half" class="w-4 h-4 fill-current"></i>`;
                    else starsHTML += `<i data-lucide="star" class="w-4 h-4"></i>`;
                }

                const amenitiesHTML = location.amenities.map(amenity => `<span class="bg-gray-700 px-2 py-1 rounded-md">${amenity}</span>`).join('');

                return `
                <div class="glass-card p-4 flex flex-col hover:border-indigo-500 transition-all duration-300">
                    <div class="flex items-start space-x-4 mb-3">
                        <div class="bg-indigo-500 p-3 rounded-lg mt-1"><i data-lucide="${location.icon || 'store'}"></i></div>
                        <div>
                            <p class="font-bold text-white">${location.name}</p>
                            <p class="text-sm text-gray-400">${location.type} - ${location.city}</p>
                        </div>
                    </div>
                    <div class="flex items-center text-yellow-400 mb-3 pl-14">
                        ${starsHTML}
                        <span class="text-xs text-gray-400 ml-2">(${rating.toFixed(1)})</span>
                    </div>
                    <div class="flex flex-wrap gap-2 text-xs mb-4 pl-14">
                        ${amenitiesHTML}
                    </div>
                    <div class="mt-auto pt-3 border-t border-gray-700 flex justify-end">
                        <button class="btn-secondary px-3 py-1 text-sm font-semibold view-on-map-btn" data-location-id="${location.id}">Voir sur la carte</button>
                    </div>
                </div>`;
            };

            const createShiftSelectConfig = () => {
                let lastDate = null;
                return {
                    mode: "multiple",
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    locale: "fr",
                    onReady: [function(selectedDates, dateStr, instance) {
                        if (!instance.calendarContainer) return;

                        instance.config.onChange.push(function(selectedDates) {
                            if (selectedDates.length) {
                                lastDate = selectedDates[selectedDates.length - 1];
                            }
                        });

                        instance.calendarContainer.addEventListener('mousedown', e => {
                            if (e.shiftKey && e.target.classList.contains("flatpickr-day")) {
                                e.preventDefault(); // Prevent text selection issues
                                if (!lastDate) return;
                                
                                const clickedDate = e.target.dateObj;
                                const range = [];
                                const start = new Date(Math.min(lastDate, clickedDate));
                                const end = new Date(Math.max(lastDate, clickedDate));
                                let current = start;

                                while (current <= end) {
                                    range.push(new Date(current));
                                    current.setDate(current.getDate() + 1);
                                }
                                
                                const newSelection = [...instance.selectedDates];
                                range.forEach(dateInRange => {
                                    if (!newSelection.find(d => d.getTime() === dateInRange.getTime())) {
                                        newSelection.push(dateInRange);
                                    }
                                });

                                instance.setDate(newSelection, true);
                            }
                        });
                    }]
                };
            };
            
            // --- "Trouver une Partie" LOGIC ---
            const renderSessions = (sessions) => {
                sessionsGrid.innerHTML = '';
                if (sessions.length === 0) {
                    noSessionsMessage.classList.remove('hidden');
                    sessionsGrid.classList.add('hidden');
                } else {
                    noSessionsMessage.classList.add('hidden');
                    sessionsGrid.classList.remove('hidden');
                    sessions.forEach(session => sessionsGrid.innerHTML += createSessionCardHTML(session));
                }
                lucide.createIcons();
            };
            
            const applySessionFilters = () => {
                const keyword = filterKeyword.value.trim().toLowerCase();
                const gameSystem = filterGameSystem.value;
                const location = filterLocation.value.trim().toLowerCase();
                const availability = filterAvailability.checked;
                const locationType = document.querySelector('input[name="location-type"]:checked').value;
                const filteredSessions = allSessions.filter(session => {
                    const keywordMatch = !keyword || session.title.toLowerCase().includes(keyword) || session.game.toLowerCase().includes(keyword);
                    const gameSystemMatch = !gameSystem || session.game === gameSystem;
                    const locationMatch = !location || session.location.toLowerCase().includes(location);
                    const availabilityMatch = !availability || session.players_current < session.players_max;
                    let locationTypeMatch = (locationType === 'online') ? session.online : (locationType === 'in-person') ? !session.online : true;
                    return keywordMatch && gameSystemMatch && locationMatch && availabilityMatch && locationTypeMatch;
                });
                renderSessions(filteredSessions);
            };

            const setupFindSessionPage = (searchParams) => {
                const gameSystems = [...new Set(allSessions.map(s => s.game))];
                filterGameSystem.innerHTML = '<option value="">Tous les systèmes</option>';
                gameSystems.sort().forEach(system => filterGameSystem.innerHTML += `<option value="${system}">${system}</option>`);
                
                filterKeyword.value = searchParams?.gameQuery || '';
                filterLocation.value = searchParams?.cityQuery || '';

                [filterKeyword, filterLocation, filterGameSystem, filterAvailability].forEach(el => el.addEventListener('input', applySessionFilters));
                filterLocationTypeRadios.forEach(radio => radio.addEventListener('change', applySessionFilters));
                applySessionFilters();
            };

            // --- "Lieux de Jeu" & MAP LOGIC ---
            const initMap = () => {
                if (map) return;
                map = L.map('map').setView([48.8, 2.35], 6); // Centered on France
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                markersLayer = L.layerGroup().addTo(map);
            };

            const renderLocations = (locations) => {
                locationsList.innerHTML = '';
                if(markersLayer) markersLayer.clearLayers();
                
                if (locations.length === 0) {
                    noLocationsMessage.classList.remove('hidden');
                } else {
                    noLocationsMessage.classList.add('hidden');
                    locations.forEach(location => {
                        locationsList.innerHTML += createLocationCardHTML(location);
                        if(markersLayer){
                            const marker = L.marker([location.lat, location.lon]).addTo(markersLayer);
                            marker.bindPopup(`<b>${location.name}</b><br>${location.type}`);
                        }
                    });
                }
                lucide.createIcons();
            };

            const applyLocationFilters = () => {
                const keyword = filterLocationKeyword.value.trim().toLowerCase();
                const type = filterLocationType.value;
                const selectedAmenities = [...document.querySelectorAll('#filter-location-amenities input:checked')].map(el => el.value);
                const filteredLocations = allLocations.filter(loc => {
                    const keywordMatch = !keyword || loc.name.toLowerCase().includes(keyword) || loc.city.toLowerCase().includes(keyword);
                    const typeMatch = !type || loc.type === type;
                    const amenitiesMatch = selectedAmenities.every(amenity => loc.amenities.includes(amenity));
                    return keywordMatch && typeMatch && amenitiesMatch;
                });
                renderLocations(filteredLocations);
            };

            const setupFindLocationPage = () => {
                initMap();
                const locationTypes = [...new Set(allLocations.map(l => l.type))];
                filterLocationType.innerHTML = '<option value="">Tous les types</option>';
                locationTypes.sort().forEach(type => filterLocationType.innerHTML += `<option value="${type}">${type}</option>`);
                const allAmenities = [...new Set(allLocations.flatMap(l => l.amenities))];
                filterLocationAmenities.innerHTML = allAmenities.map(amenity => `
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" value="${amenity}" class="form-checkbox">
                        <span>${amenity}</span>
                    </label>
                `).join('');
                filterLocationKeyword.addEventListener('input', applyLocationFilters);
                filterLocationType.addEventListener('change', applyLocationFilters);
                document.querySelectorAll('#filter-location-amenities input').forEach(el => el.addEventListener('change', applyLocationFilters));
                
                locationsList.addEventListener('click', (e) => {
                    if (e.target && e.target.classList.contains('view-on-map-btn')) {
                        const locationId = parseInt(e.target.dataset.locationId);
                        const location = allLocations.find(l => l.id === locationId);
                        if (location && map) {
                            map.setView([location.lat, location.lon], 13);
                        }
                    }
                });

                applyLocationFilters();
            };

            // --- "Groupes" LOGIC ---
            const createGroupCardHTML = (group) => {
                const games = group.games.map(g => `<span class="bg-gray-700 text-xs px-2 py-1 rounded">${g}</span>`).join(' ');
                return `
                <div class="glass-card p-6 flex flex-col hover:border-indigo-500 transition-all duration-300">
                    <div class="flex items-start space-x-4 mb-4">
                        <img src="https://placehold.co/64x64/4338ca/ffffff?text=${group.avatar}" alt="Avatar de groupe" class="rounded-lg">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white">${group.name}</h3>
                            <p class="text-sm text-indigo-300 font-semibold">${group.playstyle}</p>
                        </div>
                    </div>
                    <div class="space-y-3 text-sm text-gray-300 mb-4 flex-grow">
                        <p class="flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2 text-indigo-400"></i> ${group.location}</p>
                        <p class="flex items-start"><i data-lucide="swords" class="w-4 h-4 mr-2 text-indigo-400 mt-1"></i> <span class="flex flex-wrap gap-1">${games}</span></p>
                    </div>
                    <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-700">
                        <div class="flex items-center space-x-1">
                            <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                            <span class="font-semibold text-white">${group.members} membres</span>
                            ${group.recruiting ? '<span class="ml-2 text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded-full">Recrute</span>' : ''}
                        </div>
                        <a href="#/groups/${group.id}" class="btn-secondary px-4 py-2 rounded-lg text-sm font-semibold">Voir</a>
                    </div>
                </div>
                `;
            };
            
            const renderGroups = (groups) => {
                groupsGrid.innerHTML = '';
                if (groups.length === 0) {
                    noGroupsMessage.classList.remove('hidden');
                    groupsGrid.classList.add('hidden');
                } else {
                    noGroupsMessage.classList.add('hidden');
                    groupsGrid.classList.remove('hidden');
                    groups.forEach(group => groupsGrid.innerHTML += createGroupCardHTML(group));
                }
                lucide.createIcons();
            };

            const applyGroupFilters = () => {
                const keyword = filterGroupKeyword.value.trim().toLowerCase();
                const game = filterGroupGame.value;
                const location = filterGroupLocation.value.trim().toLowerCase();
                const recruiting = filterGroupRecruiting.checked;
                const playstyle = document.querySelector('input[name="playstyle"]:checked')?.value;
                
                const filteredGroups = allGroups.filter(g => {
                    const keywordMatch = !keyword || g.name.toLowerCase().includes(keyword);
                    const gameMatch = !game || g.games.includes(game);
                    const locationMatch = !location || g.location.toLowerCase().includes(location);
                    const recruitingMatch = !recruiting || g.recruiting;
                    const playstyleMatch = !playstyle || playstyle === 'all' || g.playstyle === playstyle;
                    return keywordMatch && gameMatch && locationMatch && recruitingMatch && playstyleMatch;
                });
                renderGroups(filteredGroups);
            };

            const setupFindGroupsPage = () => {
                const allGamesInGroups = [...new Set(allGroups.flatMap(g => g.games))];
                filterGroupGame.innerHTML = '<option value="">Tous les jeux</option>';
                allGamesInGroups.sort().forEach(game => filterGroupGame.innerHTML += `<option value="${game}">${game}</option>`);

                const playstyles = ['all', ...[...new Set(allGroups.map(g => g.playstyle))]];
                filterGroupPlaystyle.innerHTML = playstyles.map(style => `
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="playstyle" value="${style}" class="form-checkbox" ${style === 'all' ? 'checked' : ''}>
                        <span>${style === 'all' ? 'Tous' : style}</span>
                    </label>
                `).join('');

                [filterGroupKeyword, filterGroupGame, filterGroupLocation, filterGroupRecruiting].forEach(el => el.addEventListener('input', applyGroupFilters));
                document.querySelectorAll('input[name="playstyle"]').forEach(radio => radio.addEventListener('change', applyGroupFilters));

                applyGroupFilters();
            };
            
            const renderGroupDetail = (groupId) => {
                const group = allGroups.find(g => g.id === groupId);
                if (!group) {
                    window.location.hash = '#/groups';
                    return;
                }
                
                // Mock member list for display
                const members = Array.from({length: group.members}, (_, i) => `Membre ${i+1}${i===0 ? ' (Admin)' : ''}`);

                // Generate schedule polls HTML
                const schedulePollsHTML = `
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white">Planification de Session</h3>
                             <button class="btn-secondary px-4 py-2 rounded-lg text-sm font-semibold" data-action="open-poll-modal" data-group-id="${group.id}">
                                Créer un sondage
                             </button>
                        </div>
                        ${group.schedule_polls.length > 0 ? group.schedule_polls.map(poll => createPollHTML(poll, members, group.id)).join('') : '<p class="text-gray-400 glass-card p-6 text-center">Aucun sondage de planification en cours.</p>'}
                    </div>
                `;

                groupDetailView.innerHTML = `
                <div class="max-w-5xl mx-auto">
                    <a href="#/groups" class="inline-flex items-center text-indigo-400 hover:text-indigo-300 mb-6">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                        Retour à la liste des groupes
                    </a>
                    <div class="glass-card overflow-hidden">
                        <div class="h-48 bg-cover bg-center" style="background-image: url('https://placehold.co/1200x400/1f2937/4f46e5?text=${group.avatar}')"></div>
                        <div class="p-8">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center -mt-24 sm:-mt-20">
                                <div class="flex items-center space-x-4">
                                    <img src="https://placehold.co/96x96/4338ca/ffffff?text=${group.avatar}" alt="Avatar de groupe" class="rounded-2xl border-4 border-gray-800">
                                    <div>
                                        <h2 class="text-3xl font-bold text-white">${group.name}</h2>
                                        <p class="text-gray-400">${group.location}</p>
                                    </div>
                                </div>
                                <button class="btn-primary px-5 py-2 rounded-lg font-semibold mt-4 sm:mt-0">
                                    ${group.recruiting ? 'Postuler pour rejoindre' : 'Contacter le groupe'}
                                </button>
                            </div>
                            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div class="md:col-span-2">
                                    <h3 class="text-xl font-bold text-white mb-4">À propos de nous</h3>
                                    <p class="text-gray-300 whitespace-pre-line">${group.description}</p>
                                    <h3 class="text-xl font-bold text-white mt-8 mb-4">Jeux principaux</h3>
                                    <div class="flex flex-wrap gap-2">
                                         ${group.games.map(g => `<span class="tag bg-gray-700">${g}</span>`).join(' ')}
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-white mb-4">Membres (${group.members})</h3>
                                    <div class="space-y-3">
                                        ${members.map(m => `<div class="flex items-center space-x-3"><img src="https://placehold.co/40x40" class="rounded-full"><span class="font-semibold">${m}</span></div>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${schedulePollsHTML}
                </div>
                `;
                lucide.createIcons();
            };
            
            const createPollHTML = (poll, members, groupId) => {
                const voteCounts = poll.dates.map(date => poll.votes[date]?.length || 0);
                const maxVotes = Math.max(...voteCounts, 0);

                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    const options = { weekday: 'short', day: 'numeric', month: 'short' };
                    return new Intl.DateTimeFormat('fr-FR', options).format(date);
                }

                return `
                <div class="glass-card p-6 mb-6">
                    <h4 class="text-lg font-bold text-white mb-4">${poll.title}</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm poll-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Membre</th>
                                    ${poll.dates.map((date, index) => `<th class="${voteCounts[index] === maxVotes && maxVotes > 0 ? 'best-date' : ''}">${formatDate(date)}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${members.map(member => `
                                    <tr>
                                        <td>${member}</td>
                                        ${poll.dates.map(date => {
                                            const isAvailable = poll.votes[date]?.includes(currentUser?.username);
                                            const isCurrentUserCell = member === currentUser?.username;
                                            return `<td 
                                                class="poll-cell ${isAvailable ? 'available' : ''} ${isCurrentUserCell ? 'is-current-user' : ''}"
                                                data-action="toggle-vote"
                                                data-group-id="${groupId}"
                                                data-poll-id="${poll.id}"
                                                data-date="${date}"
                                                data-member="${member}">
                                                ${(isAvailable && isCurrentUserCell) ? '<i data-lucide="check"></i>' : (isAvailable && !isCurrentUserCell ? '<i data-lucide="check" class="text-gray-500"></i>' : '')}
                                            </td>`
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="font-bold text-white">
                                    <td>Total</td>
                                     ${poll.dates.map((date, index) => `<td class="${voteCounts[index] === maxVotes && maxVotes > 0 ? 'best-date' : ''}">${voteCounts[index]}</td>`).join('')}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                `;
            };

            // --- "Outils" LOGIC ---
            const setupToolsPage = () => {
                const diceCountInput = document.getElementById('dice-count');
                const diceTypeSelect = document.getElementById('dice-type');
                const rollDiceBtn = document.getElementById('roll-dice-btn');
                const diceResultEl = document.getElementById('dice-result');

                rollDiceBtn.addEventListener('click', () => {
                    const count = parseInt(diceCountInput.value) || 1;
                    const sides = parseInt(diceTypeSelect.value);
                    
                    diceResultEl.textContent = '...';
                    rollDiceBtn.disabled = true;
                    rollDiceBtn.classList.add('opacity-50', 'cursor-not-allowed');

                    setTimeout(() => {
                        let total = 0;
                        let rolls = [];
                        for (let i = 0; i < count; i++) {
                            const roll = Math.floor(Math.random() * sides) + 1;
                            rolls.push(roll);
                            total += roll;
                        }
                        
                        diceResultEl.textContent = total;
                        rollDiceBtn.disabled = false;
                        rollDiceBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }, 300);
                });
            };

            // --- "Contact" Page LOGIC ---
            const setupContactPage = () => {
                if (!contactMap) {
                    contactMap = L.map('contact-map').setView([50.6052, 3.3879], 15); // Centered on Tournai
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(contactMap);
                    L.marker([50.6052, 3.3879]).addTo(contactMap)
                        .bindPopup('<b>Bar à Dés HQ</b><br>On se prend un verre ?')
                        .openPopup();
                }
                lucide.createIcons();
            };

            // --- "Forum" Page LOGIC ---
            const setupForumPage = () => {
                const forumContent = document.getElementById('forum-content');
                const categories = [...new Set(forumTopics.map(t => t.category))];
                
                let html = '';
                categories.forEach(category => {
                    const topicsInCategory = forumTopics.filter(t => t.category === category);
                    html += `
                        <div class="glass-card">
                            <h3 class="text-xl font-bold text-white p-4 border-b border-gray-700">${category}</h3>
                            <div class="divide-y divide-gray-700">
                    `;
                    topicsInCategory.forEach(topic => {
                        html += `
                            <div class="p-4 flex items-center justify-between hover:bg-gray-800/50">
                                <div class="flex items-center">
                                    <i data-lucide="message-square" class="w-8 h-8 mr-4 text-indigo-400"></i>
                                    <div>
                                        <a href="#" class="font-semibold text-white hover:underline">${topic.title}</a>
                                        <p class="text-sm text-gray-400">par <span class="font-semibold text-indigo-300">${topic.author}</span></p>
                                    </div>
                                </div>
                                <div class="hidden sm:block text-center w-32">
                                    <p class="font-semibold text-white">${topic.replies}</p>
                                    <p class="text-xs text-gray-400">Réponses</p>
                                </div>
                                <div class="hidden md:block text-right w-48">
                                    <p class="text-sm text-white">par <span class="font-semibold text-indigo-300">${topic.lastPost.author}</span></p>
                                    <p class="text-xs text-gray-400">${topic.lastPost.time}</p>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                });
                
                forumContent.innerHTML = html;
                lucide.createIcons();
            };

            // --- "Aide" Page LOGIC ---
            const setupHelpPage = () => {
                const faqContainer = document.getElementById('faq-container');
                const faqSearch = document.getElementById('faq-search');
                const noFaqFound = document.getElementById('no-faq-found');

                const renderFaqs = (faqsToRender) => {
                    const groupedFaqs = faqsToRender.reduce((acc, faq) => {
                        if (!acc[faq.category]) {
                            acc[faq.category] = [];
                        }
                        acc[faq.category].push(faq);
                        return acc;
                    }, {});

                    let html = '';
                    for (const category in groupedFaqs) {
                        html += `
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-4" id="${category.replace(/\s/g, '-')}">${category}</h3>
                                <div class="glass-card divide-y divide-gray-700 overflow-hidden">
                        `;
                        groupedFaqs[category].forEach(faq => {
                            html += `
                                <details class="faq-item">
                                    <summary class="font-semibold text-white hover:bg-gray-800/50">
                                        <span>${faq.question}</span>
                                        <i data-lucide="chevron-down"></i>
                                    </summary>
                                    <div class="text-gray-300 leading-relaxed pt-4">
                                        <p>${faq.answer}</p>
                                    </div>
                                </details>
                            `;
                        });
                        html += `</div></div>`;
                    }
                    faqContainer.innerHTML = html;
                    lucide.createIcons();
                };
                
                renderFaqs(helpFaqs);
                
                faqSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredFaqs = helpFaqs.filter(faq => 
                        faq.question.toLowerCase().includes(searchTerm) || 
                        faq.answer.toLowerCase().includes(searchTerm)
                    );
                    renderFaqs(filteredFaqs);
                    
                    if(filteredFaqs.length === 0) {
                        noFaqFound.classList.remove('hidden');
                    } else {
                        noFaqFound.classList.add('hidden');
                    }
                });
            };

            // --- "Profile" Page LOGIC ---
            const setupProfilePage = () => {
                if (!currentUser) {
                    window.location.hash = '#/';
                    return;
                }
                const avatarPreview = document.getElementById('profile-avatar-preview');
                const avatarInput = document.getElementById('profile-avatar-input');
                const usernameInput = document.getElementById('profile-username');
                const emailInput = document.getElementById('profile-email');
                const bioInput = document.getElementById('profile-bio');

                usernameInput.value = currentUser.username;
                emailInput.value = currentUser.email;
                bioInput.value = currentUser.bio || '';
                avatarPreview.src = currentUser.avatar || `https://placehold.co/160x160/374151/d1d5db?text=${currentUser.username.charAt(0).toUpperCase()}`;

                avatarInput.addEventListener('change', () => {
                    if (avatarInput.files && avatarInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            avatarPreview.src = e.target.result;
                        };
                        reader.readAsDataURL(avatarInput.files[0]);
                    }
                });
            };

            // --- Standalone Planning LOGIC ---
            const renderPollCreation = () => {
                 planningView.innerHTML = `
                    <div class="max-w-2xl mx-auto">
                        <div class="text-center mb-12">
                            <h2 class="text-4xl font-extrabold text-white">Planifier une Session</h2>
                            <p class="text-lg text-gray-400 mt-4">Créez un sondage simple pour trouver la meilleure date pour votre groupe.</p>
                        </div>
                        <form id="standalone-poll-form" class="glass-card p-8 space-y-6">
                            <div>
                                <label for="standalone-poll-title" class="block text-sm font-medium text-gray-300 mb-2">Titre du sondage</label>
                                <input type="text" id="standalone-poll-title" class="form-input" placeholder="Ex: One-shot D&D de Novembre" required>
                            </div>
                            <div>
                                <label for="standalone-poll-dates-input" class="block text-sm font-medium text-gray-300 mb-2">Dates proposées</label>
                                <input type="text" id="standalone-poll-dates-input" class="form-input" placeholder="Cliquez pour choisir les dates..." required readonly>
                            </div>
                            <div class="pt-4">
                                <button type="submit" class="btn-primary w-full py-3 rounded-lg font-bold">Créer et obtenir le lien</button>
                            </div>
                        </form>
                    </div>
                `;
                
                flatpickr("#standalone-poll-dates-input", createShiftSelectConfig());

                document.getElementById('standalone-poll-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = document.getElementById('standalone-poll-title').value;
                    const datesString = document.getElementById('standalone-poll-dates-input').value;
                    const dates = datesString ? datesString.split(', ').sort() : [];
                    
                    if (dates.length === 0) return;

                    const newPoll = {
                        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                        title,
                        dates,
                        votes: {}
                    };
                    dates.forEach(date => newPoll.votes[date] = []);

                    allPolls.push(newPoll);
                    savePollsToStorage();
                    window.location.hash = `#/plan/${newPoll.id}`;
                });
            };
            
            const renderPollView = (pollId) => {
                const poll = allPolls.find(p => p.id === pollId);
                if (!poll) {
                    planningView.innerHTML = `<div class="text-center glass-card p-12">
                        <i data-lucide="search-x" class="w-24 h-24 text-red-400 mx-auto mb-6"></i>
                        <h3 class="text-2xl font-bold text-white mb-2">Sondage introuvable.</h3>
                        <p class="text-gray-400 mb-6">Le lien est peut-être incorrect ou le sondage a été supprimé.</p>
                        <a href="#/plan" class="btn-primary px-6 py-3 rounded-lg font-bold">Créer un nouveau sondage</a>
                    </div>`;
                    lucide.createIcons();
                    return;
                }

                const allVoters = [...new Set(Object.values(poll.votes).flat())];
                const voteCounts = poll.dates.map(date => poll.votes[date]?.length || 0);
                const maxVotes = Math.max(...voteCounts, 0);
                const shareableLink = `${window.location.origin}${window.location.pathname}#/plan/${poll.id}`;
                
                planningView.innerHTML = `
                <div class="max-w-4xl mx-auto">
                     <div class="text-center mb-8">
                        <h2 class="text-4xl font-extrabold text-white">${poll.title}</h2>
                    </div>

                    <div class="glass-card p-6 mb-8">
                        <label for="voter-name" class="block text-sm font-medium text-gray-300 mb-2">Votre nom (pour voter)</label>
                        <div class="flex gap-4">
                            <input type="text" id="voter-name" class="form-input" placeholder="Ex: Elara">
                            <div id="voter-name-error" class="text-red-400 text-sm"></div>
                        </div>
                    </div>

                    <div class="glass-card p-6 mb-8 overflow-x-auto">
                        <table class="w-full text-sm poll-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Participant</th>
                                    ${poll.dates.map((date, index) => `<th class="${voteCounts[index] === maxVotes && maxVotes > 0 ? 'best-date' : ''}">${new Date(date).toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric', month: 'short'})}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                 ${allVoters.map(voter => `
                                    <tr>
                                        <td>${voter}</td>
                                        ${poll.dates.map(date => {
                                            const isAvailable = poll.votes[date]?.includes(voter);
                                            return `<td class="${isAvailable ? 'available' : ''}">${isAvailable ? '<i data-lucide="check"></i>' : ''}</td>`
                                        }).join('')}
                                    </tr>
                                `).join('')}
                                 <tr class="bg-gray-800/50">
                                    <td class="font-bold">Vous :</td>
                                    ${poll.dates.map(date => {
                                        return `<td class="poll-cell" data-action="poll-vote" data-poll-id="${poll.id}" data-date="${date}"></td>`
                                    }).join('')}
                                </tr>
                            </tbody>
                             <tfoot>
                                <tr class="font-bold text-white">
                                    <td>Total</td>
                                     ${poll.dates.map((date, index) => `<td class="${voteCounts[index] === maxVotes && maxVotes > 0 ? 'best-date' : ''}">${voteCounts[index]}</td>`).join('')}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                     <div class="glass-card p-6 text-center">
                        <h3 class="text-lg font-bold text-white mb-3">Partagez ce sondage !</h3>
                        <input type="text" readonly value="${shareableLink}" class="form-input text-center bg-gray-900/50" onclick="this.select()">
                    </div>
                </div>
                `;
                lucide.createIcons();
            };

            // --- AUTHENTICATION & MODAL LOGIC ---
            const showModal = (modal) => modal.classList.add('active');
            const hideModal = (modal) => modal.classList.remove('active');

            const updateAuthStateUI = () => {
                const userEmail = localStorage.getItem('loggedInUser');
                currentUser = allUsers.find(u => u.email === userEmail) || null;
                
                if (currentUser) {
                    authLinks.classList.add('hidden');
                    userMenu.classList.remove('hidden');
                    userMenu.classList.add('flex');
                    usernameDisplay.textContent = currentUser.username;
                    userAvatar.src = currentUser.avatar || `https://placehold.co/40x40/4338ca/ffffff?text=${currentUser.username.charAt(0).toUpperCase()}`;
                } else {
                    authLinks.classList.remove('hidden');
                    userMenu.classList.add('hidden');
                    userMenu.classList.remove('flex');
                }
                // Re-render view if it depends on user state
                if(window.location.hash.startsWith('#/groups/')){
                    const groupId = parseInt(window.location.hash.split('/')[2]);
                    renderGroupDetail(groupId);
                }
                 if(window.location.hash === '#/profile'){
                    setupProfilePage();
                }
            };
            
            const handleLogin = (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorEl = document.getElementById('login-error');
                const user = allUsers.find(u => u.email === email && u.password === password);

                if (user) {
                    localStorage.setItem('loggedInUser', user.email);
                    updateAuthStateUI();
                    hideModal(loginModal);
                    e.target.reset();
                    errorEl.textContent = '';
                } else {
                    errorEl.textContent = 'Email ou mot de passe incorrect.';
                }
            };

            const handleRegister = (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const errorEl = document.getElementById('register-error');

                if (allUsers.some(u => u.email === email)) {
                    errorEl.textContent = 'Cet email est déjà utilisé.';
                    return;
                }
                 if (allUsers.some(u => u.username.toLowerCase() === username.toLowerCase())) {
                    errorEl.textContent = 'Ce nom d\'utilisateur est déjà pris.';
                    return;
                }

                allUsers.push({ username, email, password, bio: '', avatar: '' });
                saveUsersToStorage();
                localStorage.setItem('loggedInUser', email);
                updateAuthStateUI();
                hideModal(registerModal);
                e.target.reset();
                errorEl.textContent = '';
            };
            
            const handleProfileUpdate = (e) => {
                e.preventDefault();
                if(!currentUser) return;

                const usernameInput = document.getElementById('profile-username');
                const bioInput = document.getElementById('profile-bio');
                const avatarPreview = document.getElementById('profile-avatar-preview');
                const feedbackEl = document.getElementById('profile-feedback');
                
                const newUsername = usernameInput.value.trim();
                const newBio = bioInput.value.trim();
                const newAvatar = avatarPreview.src;

                // Validation
                if(allUsers.some(u => u.username.toLowerCase() === newUsername.toLowerCase() && u.email !== currentUser.email)) {
                    feedbackEl.textContent = "Ce nom d'utilisateur est déjà pris.";
                    feedbackEl.className = "text-red-400 text-sm text-center h-5";
                    return;
                }
                
                // Update user object in main array
                const userInDb = allUsers.find(u => u.email === currentUser.email);
                userInDb.username = newUsername;
                userInDb.bio = newBio;
                userInDb.avatar = newAvatar;
                
                saveUsersToStorage();
                updateAuthStateUI(); // This will also update the currentUser object

                feedbackEl.textContent = "Profil mis à jour avec succès !";
                feedbackEl.className = "text-green-400 text-sm text-center h-5";
                setTimeout(() => feedbackEl.textContent = "", 3000);
            };

            // --- EVENT LISTENERS & PWA ---
            const initApp = () => {
                loadUsersFromStorage();
                loadPollsFromStorage();
                
                const searchBtn = document.getElementById('search-btn');
                const gameInput = document.getElementById('game-name-input');
                const cityInput = document.getElementById('city-name-input');

                const groupPollDatepicker = flatpickr("#poll-dates-input", createShiftSelectConfig());
                
                // PWA Manifest
                const manifest = {
                    "name": "Bar à Dés", "short_name": "BaràDés", "start_url": ".", "display": "standalone",
                    "background_color": "#111827", "theme_color": "#111827", "description": "Votre plateforme pour trouver des parties de Jeu de Rôle.",
                    "icons": [{"src": "https://placehold.co/192x192/111827/4f46e5?text=BD", "sizes": "192x192", "type": "image/png"}, {"src": "https://placehold.co/512x512/111827/4f46e5?text=BD", "sizes": "512x512", "type": "image/png"}]
                };
                const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                document.querySelector('link[rel="manifest"]').setAttribute('href', URL.createObjectURL(blob));
                
                // PWA Service Worker
                if ('serviceWorker' in navigator) {
                    const swScript = document.getElementById('sw-script').textContent;
                    const swBlob = new Blob([swScript], { type: 'application/javascript' });
                    navigator.serviceWorker.register(URL.createObjectURL(swBlob)).then(reg => console.log('SW registered!', reg)).catch(err => console.log('SW registration failed:', err));
                }

                const handleRouteChange = () => {
                    const fullHash = window.location.hash || '#/';
                    const [hash, params] = fullHash.split('?');
                    
                    if (hash.startsWith('#/groups/')) {
                        const groupId = parseInt(hash.split('/')[2]);
                        showView(groupDetailView);
                        renderGroupDetail(groupId);
                        return;
                    }

                    if (hash.startsWith('#/plan/')) {
                        const pollId = hash.split('/')[2];
                        showView(planningView);
                        renderPollView(pollId);
                        return;
                    }

                    switch(hash) {
                        case '#/sessions':
                            const searchParams = new URLSearchParams(params);
                            showView(findSessionView);
                            setupFindSessionPage({ gameQuery: searchParams.get('game'), cityQuery: searchParams.get('city') });
                            break;
                        case '#/map':
                            showView(findLocationView);
                            setupFindLocationPage();
                            break;
                        case '#/groups':
                            showView(findGroupsView);
                            setupFindGroupsPage();
                            break;
                        case '#/tools':
                            showView(toolsView);
                            setupToolsPage();
                            break;
                         case '#/about':
                            showView(aboutView);
                            lucide.createIcons();
                            break;
                         case '#/contact':
                            showView(contactView);
                            setupContactPage();
                            break;
                        case '#/careers':
                            showView(careersView);
                            lucide.createIcons();
                            break;
                        case '#/charter':
                            showView(charterView);
                            lucide.createIcons();
                            break;
                        case '#/forum':
                            showView(forumView);
                            setupForumPage();
                            break;
                        case '#/help':
                            showView(helpView);
                            setupHelpPage();
                            break;
                        case '#/profile':
                            showView(profileView);
                            setupProfilePage();
                            break;
                        case '#/plan':
                            showView(planningView);
                            renderPollCreation();
                            break;
                        case '#/partner':
                            showView(partnerView);
                            lucide.createIcons();
                            break;
                        case '#/':
                        default:
                            showView(mainContent);
                            break;
                    }
                };
                
                searchBtn.addEventListener('click', () => {
                    const gameQuery = gameInput.value.trim();
                    const cityQuery = cityInput.value.trim();
                    window.location.hash = `#/sessions?game=${encodeURIComponent(gameQuery)}&city=${encodeURIComponent(cityQuery)}`;
                });
                
                // Auth & Modal Listeners
                document.getElementById('login-btn').addEventListener('click', () => showModal(loginModal));
                document.getElementById('register-btn').addEventListener('click', () => showModal(registerModal));
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('loggedInUser');
                    updateAuthStateUI();
                });
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('register-form').addEventListener('submit', handleRegister);
                document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
                
                // Poll Modal Form
                pollForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const groupId = parseInt(pollForm.dataset.currentGroupId);
                    const group = allGroups.find(g => g.id === groupId);
                    if (!group) return;

                    const title = document.getElementById('poll-title').value;
                    const datesString = document.getElementById('poll-dates-input').value;
                    const dates = datesString ? datesString.split(', ').sort() : [];
                    
                    if (dates.length === 0) return;

                    const newPoll = { id: Date.now(), title, dates, votes: {} };
                    dates.forEach(date => newPoll.votes[date] = []);
                    group.schedule_polls.push(newPoll);
                    hideModal(pollModal);
                    renderGroupDetail(groupId);
                });
                
                // Contact Form Logic
                const contactForm = document.getElementById('contact-form');
                const contactFormFeedback = document.getElementById('contact-form-feedback');
                contactForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const submitButton = contactForm.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = 'Envoi en cours...';

                    setTimeout(() => {
                        contactFormFeedback.innerHTML = `<p class="text-green-400 font-semibold">Merci ! Votre message a bien été envoyé.</p>`;
                        contactForm.reset();
                        submitButton.disabled = false;
                        submitButton.innerHTML = `<i data-lucide="send"></i><span>Envoyer le message</span>`;
                        lucide.createIcons();

                        setTimeout(() => {
                            contactFormFeedback.innerHTML = '';
                        }, 5000);
                    }, 1000);
                });

                // Partner Form Logic
                const partnerForm = document.getElementById('partner-form');
                const partnerFormFeedback = document.getElementById('partner-form-feedback');
                partnerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const submitButton = partnerForm.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = 'Envoi en cours...';

                    setTimeout(() => {
                        partnerFormFeedback.innerHTML = `<p class="text-green-400 font-semibold">Merci ! Votre demande a bien été envoyée.</p>`;
                        partnerForm.reset();
                        submitButton.disabled = false;
                        submitButton.innerHTML = `Envoyer la demande`;

                        setTimeout(() => {
                            partnerFormFeedback.innerHTML = '';
                        }, 5000);
                    }, 1000);
                });

                // Global event listener for dynamic content & modals
                document.body.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    
                    const { action, groupId, pollId, date } = target.dataset;

                    switch (action) {
                        case 'toggle-vote':
                            if (currentUser) {
                                const group = allGroups.find(g => g.id === parseInt(groupId));
                                const poll = group?.schedule_polls.find(p => p.id === parseInt(pollId));
                                if (!poll) return;
                                
                                const voteList = poll.votes[date] || [];
                                const voteIndex = voteList.indexOf(currentUser.username);
                                if (voteIndex > -1) {
                                    voteList.splice(voteIndex, 1);
                                } else {
                                    voteList.push(currentUser.username);
                                }
                                poll.votes[date] = voteList;
                                renderGroupDetail(parseInt(groupId));
                            } else {
                                showModal(loginModal);
                            }
                            break;
                        case 'poll-vote':
                            const voterNameInput = document.getElementById('voter-name');
                            const voterName = voterNameInput.value.trim();
                            if (!voterName) {
                                voterNameInput.focus();
                                voterNameInput.classList.add('border-red-500');
                                return;
                            }
                            voterNameInput.classList.remove('border-red-500');

                            const standalonePoll = allPolls.find(p => p.id === pollId);
                            if(!standalonePoll) return;

                            Object.values(standalonePoll.votes).forEach(voters => {
                                const index = voters.indexOf(voterName);
                                if (index > -1) voters.splice(index, 1);
                            });

                            const currentVotes = standalonePoll.votes[date] || [];
                            const voteIndex = currentVotes.indexOf(voterName);
                            if(voteIndex === -1) {
                                standalonePoll.votes[date].push(voterName);
                            } 
                            
                            savePollsToStorage();
                            renderPollView(pollId);
                            document.getElementById('voter-name').value = voterName; // Keep the name
                            break;
                        case 'open-poll-modal':
                            showModal(pollModal);
                            pollForm.dataset.currentGroupId = groupId;
                            break;
                        case 'close-modal':
                            const modal = target.closest('.modal-overlay');
                            if(modal.id === 'poll-modal') {
                                groupPollDatepicker.clear();
                            }
                            hideModal(modal);
                            break;
                        case 'open-login':
                            hideModal(registerModal);
                            showModal(loginModal);
                            break;
                        case 'open-register':
                            hideModal(loginModal);
                            showModal(registerModal);
                            break;
                    }
                });

                // Initial Setup
                updateAuthStateUI();
                window.addEventListener('hashchange', handleRouteChange);
                handleRouteChange();
                lucide.createIcons();
            };

            initApp();
        });
    </script>
</body>
</html>
