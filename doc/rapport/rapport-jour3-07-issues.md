# Jour 3 - Probl√®mes rencontr√©s et solutions

[‚Üê Tests](rapport-jour3-06-tests.md) | [‚Üí Retour √† l'index](rapport-jour3-00-index.md)

---

## üö® Probl√®me 1 : Crash VSCode pendant le d√©veloppement

### Sympt√¥mes

- VSCode Copilot Chat s'est ferm√© brutalement pendant la cr√©ation de `GroupsService` et `GroupsListComponent`
- Perte de la session de chat en cours
- Incertitude sur l'√©tat du code (fichiers cr√©√©s ou non)

### Analyse

**Cause probable :** Instabilit√© de VSCode Copilot Chat avec des processus en arri√®re-plan (background terminal processes) dans un monorepo Nx.

**Contexte :**
- Commande `npx nx serve barades` lanc√©e en background (isBackground: true)
- Nombreux fichiers cr√©√©s simultan√©ment (services, composants, templates, styles, tests)
- Workspace Nx large avec compilation TypeScript active

### Solution appliqu√©e

**1. V√©rification post-crash**

```bash
# V√©rifier les fichiers cr√©√©s
ls -la apps/frontend/src/app/core/services/
ls -la apps/frontend/src/app/features/groups/

# V√©rifier le contenu
cat apps/frontend/src/app/core/services/groups.service.ts
cat apps/frontend/src/app/features/groups/groups-list.ts
```

**R√©sultat :** Tous les fichiers √©taient cr√©√©s et complets ‚úÖ

**2. Commandes manuelles fournies**

Au lieu de relancer des processus background, fourniture de commandes √† ex√©cuter manuellement :

```bash
# Build
npx nx build barades

# Serve (manuel, pas en background)
npx nx serve barades

# Tests
npx nx test barades
```

### Le√ßons apprises

| ‚ùå √Ä √©viter | ‚úÖ √Ä privil√©gier |
|-------------|------------------|
| `run_in_terminal` avec `isBackground: true` pour serveur | Commande manuelle dans terminal utilisateur |
| Cr√©ation massive de fichiers en une fois | Cr√©ation par petits lots avec commits interm√©diaires |
| Processus longs (serve, watch) via Copilot Chat | Lancement manuel par l'utilisateur |

**Impact :** Aucune perte de code gr√¢ce aux fichiers cr√©√©s avant le crash.

---

## üó∫Ô∏è Probl√®me 2 : Tuiles Leaflet partiellement charg√©es

### Sympt√¥mes

- Carte Leaflet affich√©e avec bonnes dimensions (571x600 px)
- 3 markers pr√©sents et cliquables
- ‚ùå Seulement 2 tuiles OpenStreetMap charg√©es (au lieu de ~12 attendues)
- Reste de la carte affich√©e en gris

**Screenshot utilisateur :**
> "Je vois la carte mais seulement 2 tuiles au lieu de toute la carte"

### Analyse

**Timeline des tentatives :**

#### Tentative 1 : Passage de `*ngIf` √† `[class.hidden]`

**Hypoth√®se :** Le container est d√©truit/recr√©√© avec `*ngIf`, emp√™chant Leaflet de calculer les dimensions.

```html
<!-- Avant -->
<div id="map" *ngIf="mapVisible" class="locations-map"></div>

<!-- Apr√®s -->
<div id="map" [class.hidden]="!mapVisible" class="locations-map"></div>
```

```css
.locations-map.hidden {
  display: none;
}
```

**R√©sultat :** ‚ùå Pas d'am√©lioration

---

#### Tentative 2 : Hauteur CSS fixe

**Hypoth√®se :** Hauteur calcul√©e dynamique (`calc(100vh - 150px)`) pose probl√®me.

```css
/* Avant */
.locations-map {
  height: calc(100vh - 150px);
}

/* Apr√®s */
.locations-map {
  height: 600px;  /* Hauteur fixe */
}
```

**Logs de v√©rification :**
```typescript
console.log('[LocationsList] Container dimensions:', container.clientWidth, container.clientHeight);
// ‚Üí Output: 571 600 ‚úÖ
```

**R√©sultat :** ‚ùå Pas d'am√©lioration (mais dimensions confirm√©es correctes)

---

#### Tentative 3 : Timing d'initialisation

**Hypoth√®se :** Leaflet s'initialise avant que le container soit visible/stable.

```typescript
// Avant
ngAfterViewInit() {
  this.initMap();
}

// Apr√®s
ngAfterViewInit() {
  setTimeout(() => this.initMap(), 100);
}
```

**Augmentation du d√©lai :**
```typescript
setTimeout(() => this.initMap(), 500);  // 100ms ‚Üí 500ms
```

**R√©sultat :** ‚ùå Pas d'am√©lioration

---

#### Tentative 4 : `invalidateSize()` apr√®s ajout tuiles

**Hypoth√®se :** Leaflet ne recalcule pas apr√®s ajout des tuiles.

```typescript
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '...',
  maxZoom: 19
}).addTo(this.map);

console.log('[LocationsList] Tiles added');
this.map.invalidateSize();  // ‚úÖ Ajout√©
```

**R√©sultat :** ‚ùå Pas d'am√©lioration

---

#### Tentative 5 : Logs de debugging extensifs

**Ajout de logs √† chaque √©tape :**

```typescript
initMap() {
  const container = document.getElementById('map');
  if (!container) {
    console.error('[LocationsList] Map container not found');
    return;
  }

  console.log('[LocationsList] Container found');
  console.log('[LocationsList] Container dimensions:', container.clientWidth, container.clientHeight);
  
  this.map = L.map('map').setView([50.8503, 4.3517], 12);
  console.log('[LocationsList] Map initialized');
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '...',
    maxZoom: 19
  }).addTo(this.map);
  console.log('[LocationsList] Tiles added');
  
  this.addMarkers();
}

addMarkers() {
  if (!this.map) return;

  console.log('[LocationsList] Adding markers for', this.locations.length, 'locations');
  
  this.locations.forEach((location, index) => {
    console.log(`[LocationsList] Adding marker ${index + 1}:`, location.name, location.lat, location.lon);
    
    const marker = L.marker([location.lat, location.lon], {
      icon: this.getLocationIcon(location.icon)
    }).addTo(this.map!);
    
    marker.bindPopup(this.createPopupContent(location));
    
    console.log(`[LocationsList] Marker ${index + 1} added`);
  });
  
  console.log('[LocationsList] All markers added');
}
```

**Output console :**
```
[LocationsList] Container found
[LocationsList] Container dimensions: 571 600
[LocationsList] Map initialized
[LocationsList] Tiles added
[LocationsList] Adding markers for 3 locations
[LocationsList] Adding marker 1: Outpost Brussels 50.8415 4.3791
[LocationsList] Marker 1 added
[LocationsList] Adding marker 2: Gamer's Tavern 50.8467 4.3525
[LocationsList] Marker 2 added
[LocationsList] Adding marker 3: The Dice Hub 50.8353 4.3389
[LocationsList] Marker 3 added
[LocationsList] All markers added
```

**R√©sultat :** ‚úÖ Logs OK, mais tuiles toujours partielles ‚ùå

---

### Hypoth√®ses restantes (non test√©es)

#### H1 : Probl√®me r√©seau CDN OpenStreetMap

**√Ä v√©rifier dans DevTools Network :**
- Est-ce que les requ√™tes vers `tile.openstreetmap.org` √©chouent ?
- Y a-t-il des erreurs CORS ?
- Les tuiles sont-elles en cache avec statut 304 ?

**Test √† faire :**
```typescript
const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '...',
  maxZoom: 19
});

tileLayer.on('tileerror', (error) => {
  console.error('[LocationsList] Tile error:', error);
});

tileLayer.on('tileload', (event) => {
  console.log('[LocationsList] Tile loaded:', event);
});

tileLayer.addTo(this.map);
```

#### H2 : Probl√®me de z-index ou CSS

**√Ä v√©rifier :**
```css
.locations-map {
  position: relative;
  z-index: 1;
}

/* S'assurer qu'aucun √©l√©ment ne chevauche */
.locations-map * {
  box-sizing: border-box;
}
```

#### H3 : Forcer le reload des tuiles

**Code √† tester :**
```typescript
ngAfterViewInit() {
  setTimeout(() => {
    this.initMap();
    
    // Force redraw apr√®s 1 seconde
    setTimeout(() => {
      this.map?.eachLayer((layer) => {
        if (layer instanceof L.TileLayer) {
          layer.redraw();
        }
      });
    }, 1000);
  }, 100);
}
```

#### H4 : Utiliser un CDN alternatif

**Autres fournisseurs de tuiles :**
```typescript
// CartoDB
'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'

// Mapbox (n√©cessite API key)
'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}'

// Stamen
'https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png'
```

---

### Impact utilisateur

| Fonctionnalit√© | Status | Impact |
|----------------|--------|--------|
| Affichage de la carte | ‚úÖ | Dimensions correctes |
| Markers | ‚úÖ | 3 markers visibles et cliquables |
| Popups | ‚úÖ | Informations compl√®tes affich√©es |
| Tuiles | ‚ö†Ô∏è | 2/12 tuiles (visuel peu esth√©tique) |
| Toggle map/list | ‚úÖ | Fallback vers liste fonctionne |

**D√©cision produit :** 
- ‚úÖ Fonctionnalit√© utilisable (markers cliquables)
- ‚ö†Ô∏è Probl√®me visuel mais non bloquant
- üìù Document√© pour r√©solution Jour 4+
- üí° Fallback liste disponible

---

## üß™ Probl√®me 3 : Tests Footer initiaux vides

### Sympt√¥mes

```bash
npx nx test barades
```

**Erreur :**
```
FAIL  apps/frontend/src/app/core/navigation/footer.spec.ts
  ‚óè FooterComponent ‚Ä∫ has no tests

    Your test suite must contain at least one test.
```

### Analyse

**Code initial :**
```typescript
describe('FooterComponent', () => {
  let component: FooterComponent;
  let fixture: ComponentFixture<FooterComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [FooterComponent],
      providers: [provideRouter([])]
    }).compileComponents();

    fixture = TestBed.createComponent(FooterComponent);
    component = fixture.componentInstance;
  });

  // ‚ùå Aucun test it() d√©fini
});
```

**Cause :** Jest exige au moins un test `it()` dans chaque `describe()`.

### Solution

**Ajout de 4 tests :**

```typescript
it('should create', () => {
  expect(component).toBeTruthy();
});

it('should display current year in copyright', () => {
  fixture.detectChanges();
  const compiled = fixture.nativeElement as HTMLElement;
  const currentYear = new Date().getFullYear();
  const copyrightText = compiled.querySelector('.footer-copyright')?.textContent;
  
  expect(copyrightText).toContain(currentYear.toString());
});

it('should render 4 footer sections', () => {
  fixture.detectChanges();
  const compiled = fixture.nativeElement as HTMLElement;
  const sections = compiled.querySelectorAll('.footer-section');
  
  expect(sections.length).toBe(4);
});

it('should render social links', () => {
  fixture.detectChanges();
  const compiled = fixture.nativeElement as HTMLElement;
  const socialLinks = compiled.querySelectorAll('.social-link');
  
  expect(socialLinks.length).toBe(4);
});
```

**R√©sultat :** ‚úÖ 22/22 tests passing

---

## üîÑ Probl√®me 4 : Erreur Git "pathspec did not match"

### Sympt√¥mes

```bash
git add apps/frontend/src/app/core/navigation/footer.ts \
  apps/frontend/src/app/core/navigation/footer.ts \
  apps/frontend/src/app/core/navigation/footer.html \
  # ...
```

**Erreur :**
```
fatal: pathspec 'apps/frontend/src/app/core/navigation/footer.ts' did not match any files
```

### Analyse

**Cause :** Commande `git add` dupliqu√©e avec le m√™me fichier deux fois.

**Context :** Agent a g√©n√©r√© une commande avec r√©p√©tition :
```bash
git add apps/frontend/src/app/core/navigation/footer.ts \
  apps/frontend/src/app/core/navigation/footer.ts \  # ‚ùå R√©p√©t√©
  apps/frontend/src/app/core/navigation/footer.html \
  # ...
```

### Solution

**Utilisateur a re-lanc√© la commande proprement :**
```bash
git add apps/frontend/src/app/core/navigation/footer.ts \
  apps/frontend/src/app/core/navigation/footer.html \
  apps/frontend/src/app/core/navigation/footer.css \
  apps/frontend/src/app/core/navigation/footer.spec.ts \
  apps/frontend/src/app/core/layouts/app-layout.ts \
  apps/frontend/src/app/core/layouts/app-layout.html \
  apps/frontend/src/app/core/layouts/app-layout.css

git commit -m "feat(frontend): add Footer component with 4 sections and social links"
```

**R√©sultat :** ‚úÖ Commit 4417bdb cr√©√© avec succ√®s

---

## üìä R√©sum√© des probl√®mes

| # | Probl√®me | Gravit√© | Status | Solution |
|---|----------|---------|--------|----------|
| 1 | Crash VSCode | ‚ö†Ô∏è Moyenne | ‚úÖ R√©solu | √âviter background terminals, cr√©er par lots |
| 2 | Tuiles Leaflet partielles | ‚ö†Ô∏è Moyenne | ‚è∏Ô∏è En cours | 5 tentatives, debugging extensif, document√© |
| 3 | Tests Footer vides | üî¥ Haute | ‚úÖ R√©solu | Ajout de 4 tests it() |
| 4 | Git pathspec error | üü° Faible | ‚úÖ R√©solu | Commande sans duplication |

---

## üîß Outils de debugging utilis√©s

### 1. Console logs

```typescript
console.log('[LocationsList] Container dimensions:', container.clientWidth, container.clientHeight);
console.log('[LocationsList] Map initialized');
console.log('[LocationsList] Tiles added');
```

**Avantages :**
- ‚úÖ Rapide √† impl√©menter
- ‚úÖ Trace le flow d'ex√©cution
- ‚úÖ V√©rifie les valeurs √† chaque √©tape

### 2. Browser DevTools

**Network tab :**
- V√©rifier les requ√™tes vers OpenStreetMap
- Statuts HTTP (200, 404, CORS errors)

**Console tab :**
- Voir les logs `[LocationsList]`
- Erreurs JavaScript

**Elements tab :**
- Inspecter le DOM g√©n√©r√©
- V√©rifier les dimensions r√©elles

### 3. Git diff

```bash
git diff HEAD~1 HEAD
git log --oneline -5
```

**V√©rifier :**
- Fichiers modifi√©s vs attendus
- Commits pr√©c√©dents

---

## üìù Documentation du debugging

**Tous les logs ajout√©s sont pr√©fix√©s `[LocationsList]` pour faciliter le filtrage :**

```typescript
console.log('[LocationsList] Container found');
console.log('[LocationsList] Map initialized');
console.log('[LocationsList] Tiles added');
console.log('[LocationsList] Adding markers for', this.locations.length, 'locations');
console.log(`[LocationsList] Adding marker ${index + 1}:`, location.name);
```

**Format standardis√© :**
1. Pr√©fixe du composant entre crochets
2. Message descriptif
3. Donn√©es contextuelles si pertinent

**B√©n√©fices :**
- ‚úÖ Filtrage console : `/LocationsList/`
- ‚úÖ Compr√©hension rapide du flow
- ‚úÖ Debug par √©tapes

---

## üéØ Prochaines actions (Jour 4+)

### Pour Leaflet

1. ‚úÖ Tester event listeners `tileerror` et `tileload`
2. ‚úÖ V√©rifier Network DevTools (CORS, 404, cache)
3. ‚úÖ Essayer CDN alternatif (CartoDB, Stamen)
4. ‚úÖ Tester `layer.redraw()` apr√®s 1 seconde
5. ‚úÖ Comparer avec exemple Leaflet minimal (hors Angular)

### Pour VSCode stabilit√©

1. ‚úÖ Cr√©er fichiers par petits lots
2. ‚úÖ Commiter fr√©quemment (apr√®s chaque fonctionnalit√©)
3. ‚úÖ √âviter `isBackground: true` pour serveurs dev
4. ‚úÖ Privil√©gier commandes manuelles utilisateur

### Pour les tests

1. ‚úÖ Toujours ajouter au moins un test `it()` dans `describe()`
2. ‚úÖ Tester apr√®s chaque cr√©ation de composant
3. ‚úÖ Utiliser `--watch` mode pendant d√©veloppement

---

## üîó Navigation

- [‚Üê Retour √† Tests](rapport-jour3-06-tests.md)
- [‚Üí Retour √† l'index](rapport-jour3-00-index.md)
